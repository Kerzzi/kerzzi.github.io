
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ3ï¼‰ | æŸ¯å­çš„è¡Œæ€ç¬”è®°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Kerzzi">
    

    
    <meta name="description" content="è¯¾ç¨‹ç›®æ ‡ Part 1: å‰è¨€ ç½‘ç«™æ•ˆèƒ½åŸºç¡€æ¦‚å¿µ   Part 2: å‰ç«¯æ•ˆèƒ½ å‰ç«¯æ•ˆèƒ½åˆ†æ å‡å°‘ Requests æ•°é‡å’Œå¤§å° HTTP æœ€ä½³åŒ– å…³é”®æ¸²æŸ“è·¯å¾„ CDN   Part 3: åç«¯æ•ˆèƒ½ é¡¹ç›®å‡†å¤‡ åç«¯æ•ˆèƒ½åˆ†æ é¿å… N+1 SQL æŸ¥è¯¢ ActiveRecord ä¼˜åŒ–æŠ€å·§ æ•°æ®åº“ SQL ä¼˜åŒ– è®¡æ•°ç¼“å­˜ (Counter Cache) æ”¹è¿› Render Partial çš„æ•ˆèƒ½ æ•°æ®">
<meta name="keywords" content="æ–°ç”Ÿå¤§å­¦å…¨æ ˆè¥,Ruby on Rails,å…¨æ ˆè¥è¯¾ç¨‹å¤ç›˜">
<meta property="og:type" content="article">
<meta property="og:title" content="è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ3ï¼‰">
<meta property="og:url" content="https://kerzzi.github.io/2017/10/06/2017-10-06-rails-website-performance-03/index.html">
<meta property="og:site_name" content="æŸ¯å­çš„è¡Œæ€ç¬”è®°">
<meta property="og:description" content="è¯¾ç¨‹ç›®æ ‡ Part 1: å‰è¨€ ç½‘ç«™æ•ˆèƒ½åŸºç¡€æ¦‚å¿µ   Part 2: å‰ç«¯æ•ˆèƒ½ å‰ç«¯æ•ˆèƒ½åˆ†æ å‡å°‘ Requests æ•°é‡å’Œå¤§å° HTTP æœ€ä½³åŒ– å…³é”®æ¸²æŸ“è·¯å¾„ CDN   Part 3: åç«¯æ•ˆèƒ½ é¡¹ç›®å‡†å¤‡ åç«¯æ•ˆèƒ½åˆ†æ é¿å… N+1 SQL æŸ¥è¯¢ ActiveRecord ä¼˜åŒ–æŠ€å·§ æ•°æ®åº“ SQL ä¼˜åŒ– è®¡æ•°ç¼“å­˜ (Counter Cache) æ”¹è¿› Render Partial çš„æ•ˆèƒ½ æ•°æ®">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/006tNc79gy1fk8q5ntcfdj30wz0tadgs.jpg">
<meta property="og:image" content="https://ww1.sinaimg.cn/large/006tNc79gy1fk8q6eyzyaj30wg110759.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/006tNc79ly1fk8q7fyuf5j30w706nt90.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/006tNc79gy1fk8qh82up2j30wz0tajsg.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/006tNc79gy1fk8qhp2olej30wb0qx3zq.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/006tNc79ly1fk8qltkggnj30w70d6t9r.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/006tNc79gy1fk8qtcat0rj30wa0qhab5.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/006tNc79gy1fk8qtgcae0j30wc0cg3ze.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/006tNc79ly1fk8rg9fdm4j30w40cm3z8.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/006tNc79gy1fk8rchwo27j308w056wev.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/006tNc79gy1fk8rctxremj308j054dfq.jpg">
<meta property="og:image" content="https://ww1.sinaimg.cn/large/006tNc79gy1fk8rd423iwj30dq05cdfu.jpg">
<meta property="og:image" content="https://ww1.sinaimg.cn/large/006tNc79gy1fk8rdern5mj30i007mjrf.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/006tNc79gy1fk8rdui9vxj30j305zdfv.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/006tNc79gy1fk8re94najj30hg07maa6.jpg">
<meta property="og:updated_time" content="2017-10-06T11:43:01.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ3ï¼‰">
<meta name="twitter:description" content="è¯¾ç¨‹ç›®æ ‡ Part 1: å‰è¨€ ç½‘ç«™æ•ˆèƒ½åŸºç¡€æ¦‚å¿µ   Part 2: å‰ç«¯æ•ˆèƒ½ å‰ç«¯æ•ˆèƒ½åˆ†æ å‡å°‘ Requests æ•°é‡å’Œå¤§å° HTTP æœ€ä½³åŒ– å…³é”®æ¸²æŸ“è·¯å¾„ CDN   Part 3: åç«¯æ•ˆèƒ½ é¡¹ç›®å‡†å¤‡ åç«¯æ•ˆèƒ½åˆ†æ é¿å… N+1 SQL æŸ¥è¯¢ ActiveRecord ä¼˜åŒ–æŠ€å·§ æ•°æ®åº“ SQL ä¼˜åŒ– è®¡æ•°ç¼“å­˜ (Counter Cache) æ”¹è¿› Render Partial çš„æ•ˆèƒ½ æ•°æ®">
<meta name="twitter:image" content="https://ww3.sinaimg.cn/large/006tNc79gy1fk8q5ntcfdj30wz0tadgs.jpg">

    
    <link rel="alternative" href="/atom.xml" title="æŸ¯å­çš„è¡Œæ€ç¬”è®°" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.png">
    
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="æŸ¯å­çš„è¡Œæ€ç¬”è®°">æŸ¯å­çš„è¡Œæ€ç¬”è®°</a></h1>
				<h2 class="blog-motto">å«æˆ‘æŸ¯å­å°±å¥½</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">é¦–é¡µ</a></li>
					
						<li><a href="/archives">å½’æ¡£</a></li>
					
						<li><a href="/tags">æ ‡ç­¾</a></li>
					
						<li><a href="/about">å…³äº</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="æœç´¢" />
						<input type="hidden" name="q" value="site:kerzzi.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/10/06/2017-10-06-rails-website-performance-03/" title="è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ3ï¼‰" itemprop="url">è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ3ï¼‰</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kerzzi" target="_blank" itemprop="author">Kerzzi</a>
		
  <p class="article-time">
    <time datetime="2017-10-05T16:00:00.000Z" itemprop="datePublished"> å‘è¡¨äº 2017-10-06</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">æ–‡ç« ç›®å½•</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#è¯¾ç¨‹ç›®æ ‡"><span class="toc-number">1.</span> <span class="toc-text">è¯¾ç¨‹ç›®æ ‡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#è¯¾ç¨‹å¤ç›˜"><span class="toc-number">2.</span> <span class="toc-text">è¯¾ç¨‹å¤ç›˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-æ•°æ®åº“-SQL-ä¼˜åŒ–"><span class="toc-number">2.1.</span> <span class="toc-text">1. æ•°æ®åº“ SQL ä¼˜åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-è®¡æ•°ç¼“å­˜-Counter-Cache"><span class="toc-number">2.2.</span> <span class="toc-text">2. è®¡æ•°ç¼“å­˜ (Counter Cache)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#è®¡æ•°ç¼“å­˜-Counter-Cache"><span class="toc-number">2.2.1.</span> <span class="toc-text">è®¡æ•°ç¼“å­˜ (Counter Cache)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å†ä¸€ä¸ªé€†è§„èŒƒåŒ–çš„ä¾‹å­"><span class="toc-number">2.2.2.</span> <span class="toc-text">å†ä¸€ä¸ªé€†è§„èŒƒåŒ–çš„ä¾‹å­</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å°ç»“è®ºï¼šä»€ä¹ˆæ—¶å€™ç”¨é€†è§„èŒƒåŒ–åšä¼˜åŒ–ï¼Ÿ"><span class="toc-number">2.2.3.</span> <span class="toc-text">å°ç»“è®ºï¼šä»€ä¹ˆæ—¶å€™ç”¨é€†è§„èŒƒåŒ–åšä¼˜åŒ–ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-æ”¹è¿›-Render-Partial-çš„æ•ˆèƒ½"><span class="toc-number">2.3.</span> <span class="toc-text">3. æ”¹è¿› Render Partial çš„æ•ˆèƒ½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-æ•°æ®åº“ç´¢å¼•"><span class="toc-number">2.4.</span> <span class="toc-text">4. æ•°æ®åº“ç´¢å¼•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å¸¸è§çš„æ•ˆèƒ½é”™è¯¯"><span class="toc-number">2.4.1.</span> <span class="toc-text">å¸¸è§çš„æ•ˆèƒ½é”™è¯¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL-explain-æœºåˆ¶"><span class="toc-number">2.4.2.</span> <span class="toc-text">SQL explain æœºåˆ¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-åç«¯ç¼“å­˜å’Œå»¶å±•æ€§-Scalability"><span class="toc-number">2.5.</span> <span class="toc-text">5. åç«¯ç¼“å­˜å’Œå»¶å±•æ€§(Scalability)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å†…å­˜ç¼“å­˜"><span class="toc-number">2.5.1.</span> <span class="toc-text">å†…å­˜ç¼“å­˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ç½‘ç«™å»¶å±•æ€§"><span class="toc-number">2.5.2.</span> <span class="toc-text">ç½‘ç«™å»¶å±•æ€§</span></a></li></ol></li></ol></li></ol>
		
		</div>
		
		<h2 id="è¯¾ç¨‹ç›®æ ‡"><a href="#è¯¾ç¨‹ç›®æ ‡" class="headerlink" title="è¯¾ç¨‹ç›®æ ‡"></a>è¯¾ç¨‹ç›®æ ‡</h2><ul>
<li>Part 1: å‰è¨€<ul>
<li>ç½‘ç«™æ•ˆèƒ½åŸºç¡€æ¦‚å¿µ</li>
</ul>
</li>
<li>Part 2: å‰ç«¯æ•ˆèƒ½<ul>
<li>å‰ç«¯æ•ˆèƒ½åˆ†æ</li>
<li>å‡å°‘ Requests æ•°é‡å’Œå¤§å°</li>
<li>HTTP æœ€ä½³åŒ–</li>
<li>å…³é”®æ¸²æŸ“è·¯å¾„</li>
<li>CDN</li>
</ul>
</li>
<li>Part 3: åç«¯æ•ˆèƒ½<ul>
<li>é¡¹ç›®å‡†å¤‡</li>
<li>åç«¯æ•ˆèƒ½åˆ†æ</li>
<li>é¿å… N+1 SQL æŸ¥è¯¢</li>
<li>ActiveRecord ä¼˜åŒ–æŠ€å·§</li>
<li>æ•°æ®åº“ SQL ä¼˜åŒ–</li>
<li>è®¡æ•°ç¼“å­˜ (Counter Cache)</li>
<li>æ”¹è¿› Render Partial çš„æ•ˆèƒ½</li>
<li>æ•°æ®åº“ç´¢å¼•</li>
<li>åç«¯ç¼“å­˜å’Œå»¶å±•æ€§(Scalability)</li>
</ul>
</li>
</ul>
<h2 id="è¯¾ç¨‹å¤ç›˜"><a href="#è¯¾ç¨‹å¤ç›˜" class="headerlink" title="è¯¾ç¨‹å¤ç›˜"></a>è¯¾ç¨‹å¤ç›˜</h2><h3 id="1-æ•°æ®åº“-SQL-ä¼˜åŒ–"><a href="#1-æ•°æ®åº“-SQL-ä¼˜åŒ–" class="headerlink" title="1. æ•°æ®åº“ SQL ä¼˜åŒ–"></a>1. æ•°æ®åº“ SQL ä¼˜åŒ–</h3><p>è¶Šäº†è§£ SQLï¼Œä½¿ç”¨ ActiveRecord å°±è¶Šå¾—å¿ƒåº”æ‰‹ã€‚æµè§ˆ <a href="http://localhost:3000/posts/report" target="_blank" rel="external">http://localhost:3000/posts/report</a> è¿™ä¸€é¡µï¼š<br><img src="https://ww3.sinaimg.cn/large/006tNc79gy1fk8q5ntcfdj30wz0tadgs.jpg" alt=""></p>
<p>è¿™ä¸€é¡µä¼šæ˜¾ç¤ºå“ªäº› Post çš„è®¢é˜…æ•°(Subscription)æœ€å¤šï¼Œä¾ç…§ç•™è¨€æ•°æ’åºï¼š</p>
<p>çœ‹ä¸€ä¸‹ logï¼Œä¸å¤ªå¦™ï¼š<br><img src="https://ww1.sinaimg.cn/large/006tNc79gy1fk8q6eyzyaj30wg110759.jpg" alt=""></p>
<p>æœ¬æ¥çš„å®ä½œæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿæ‰“å¼€ <code>app/controllers/posts_controller.rb</code> è¿™ä¸ªæ¡£æ¡ˆè¿›è¡Œä¼˜åŒ–ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/controllers/posts_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">report</span></span></div><div class="line">-  @posts = Post.all.<span class="keyword">include</span>(<span class="symbol">:user</span>).sort_by&#123; <span class="params">|post|</span> post.subscriptions.size &#125;.reverse[<span class="number">0</span>,<span class="number">10</span>]</div><div class="line">+  @posts = Post.includes(<span class="symbol">:user</span>).joins(<span class="symbol">:subscriptions</span>).group(<span class="string">"posts.id"</span>).select(<span class="string">"posts.*, COUNT(subscriptions.id) as subscriptions_count"</span>).order(<span class="string">"subscriptions_count DESC"</span>).limit(<span class="number">10</span>)</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>æ¥ç€ä¿®æ”¹ <code>app/views/posts/report.html.erb</code></p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/report.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-  &lt;td&gt;&lt;%= post.subscriptions.size %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">+  &lt;td&gt;&lt;%= post.subscriptions_count %&gt;&lt;/td</span>&gt;</div></pre></td></tr></table></figure>
<p>ä¼˜åŒ–ä¹‹åçš„ç»“æœï¼š<br><img src="https://ww3.sinaimg.cn/large/006tNc79ly1fk8q7fyuf5j30w706nt90.jpg" alt=""></p>
<p>è§£è¯´ï¼šå› ä¸ºè®¢é˜…æ•°å¹¶ä¸æ˜¯ Post çš„ä¸€ä¸ªå­—æ®µï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥å†™ Post.order(â€œsubscriptions_count DESCâ€).limit(10)ï¼Œéœ€è¦æƒ³åŠæ³•å»è®¡ç®—è®¢é˜…æ•°ï¼š</p>
<ul>
<li>æœ¬æ¥çš„åšæ³•éœ€è¦æå‡ºæ‰€æœ‰çš„ Post è´´æ–‡åˆ°å†…å­˜ä¸­ï¼Œæ¯ç¯‡è´´æ–‡è®¡ç®—è®¢é˜…æ•°ï¼Œç„¶åæ•°ç»„æ’åºä¹‹åï¼Œå–å‡ºå‰åå</li>
<li>æ–°çš„åšæ³•æ˜¯ SQL çš„ group è¯­æ³•ï¼Œäº¤ç”±æ•°æ®åº“çš„å¼•æ“æ¥è®¡ç®—ï¼Œæœ€ååˆšåˆšå¥½å–å‡º 10 ç¬”æ•°æ®æˆä¸º Ruby å¯¹è±¡æ”¾å…¥å†…å­˜</li>
</ul>
<blockquote>
<p>åœ¨è´­ç‰©ç½‘ç«™ä¸­ï¼Œè¿™ä¸ªå…¶å®å°±æ˜¯è´­ç‰©è½¦åˆ†æçš„åŠŸèƒ½ï¼šä½ å¯ä»¥åˆ†æå“ªäº›å•†å“æœ€å¸¸è¢«åŠ å…¥è´­ç‰©è½¦ä½†æ˜¯æ²¡æœ‰ç»“å¸ã€‚<br>åƒè¿™ç§è®¡ç®—æŠ¥è¡¨ç±»å‹çš„åº”ç”¨ï¼Œå¦‚æœä½ æŠŠæ•°æ®ä»æ•°æ®åº“éƒ½å–å‡ºç”¨ Ruby æ¥è®¡ç®—çš„è¯ï¼Œæ•ˆèƒ½ä¼šéå¸¸å·®ã€‚ä½ éœ€è¦åˆ©ç”¨ SQL æ¥è®©æ•°æ®åº“å¼•æ“æ¥åšå†…éƒ¨è¿ç®—ï¼Œæ•ˆèƒ½æ‰ä¼šå¿«ã€‚</p>
</blockquote>
<h3 id="2-è®¡æ•°ç¼“å­˜-Counter-Cache"><a href="#2-è®¡æ•°ç¼“å­˜-Counter-Cache" class="headerlink" title="2. è®¡æ•°ç¼“å­˜ (Counter Cache)"></a>2. è®¡æ•°ç¼“å­˜ (Counter Cache)</h3><p>åœ¨æ•°æ®åº“æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬æè¿‡é€†è§„èŒƒåŒ–(Denormalized)çš„æ¦‚å¿µï¼Œè¿™ä¸€ç« è®©æˆ‘ä»¬æ¥å®é™…å®ä½œçœ‹çœ‹ã€‚</p>
<p>æƒ³è¦åšçš„æƒ…å¢ƒæ˜¯ posts index é¡µé¢ä¸Šï¼Œæˆ‘ä»¬æƒ³è¦æ˜¾ç¤ºè®¢é˜…æ•°(Subscriptions)ã€‚é¦–å…ˆç¼–è¾‘ <code>app/views/posts/index.html.erb</code> åŠ ä¸Šè®¢é˜…æ•°ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/index.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;th&gt;ç•™è¨€æ•°&lt;<span class="regexp">/th&gt;</span></div><div class="line"><span class="regexp">+   &lt;th&gt;è®¢é˜…æ•°&lt;/th</span>&gt;</div><div class="line"></div><div class="line"><span class="comment"># ç•¥</span></div><div class="line"></div><div class="line">&lt;td&gt;&lt;%= post.visible_comments.size %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">+   &lt;td&gt;&lt;%= post.subscriptions.size %&gt;&lt;/td</span>&gt;</div></pre></td></tr></table></figure>
<p><img src="https://ww2.sinaimg.cn/large/006tNc79gy1fk8qh82up2j30wz0tajsg.jpg" alt=""><br>ä¸æ„å¤–çš„ï¼Œè¿™æ ·å†™é€ æˆäº†å¾ˆå¤š SQL æŸ¥è¯¢ï¼š</p>
<p><img src="https://ww3.sinaimg.cn/large/006tNc79gy1fk8qhp2olej30wb0qx3zq.jpg" alt=""><br>è·Ÿæ˜¾ç¤º <code>visible_comments</code> ç•™è¨€æ•°ä¸åŒï¼Œè®¢é˜…çš„æ•°æ®å¹¶æ²¡æœ‰è¢«é¢„å…ˆåŠ è½½ï¼Œæ‰€ä»¥éœ€è¦ä¸€ç¬”ä¸€ç¬”å» COUNTã€‚è¦æ€ä¹ˆæ”¹å–„å‘¢ï¼Ÿ</p>
<p>å¦‚æœä½ ç†Ÿæ‚‰ SQL çš„è¯ï¼Œå¯ä»¥ç”¨ SQL è§£å†³ï¼Œç¼–è¾‘ <code>app/controllers/posts_controller.rb</code>ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/controllers/posts_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">index</span></span></div><div class="line">    @posts = Post.includes(<span class="symbol">:user</span>, <span class="symbol">:liked_users</span>, &#123; <span class="symbol">:visible_comments</span> =&gt; <span class="symbol">:user</span> &#125; ).page(params[<span class="symbol">:page</span>])</div><div class="line"></div><div class="line">+   post_ids = @posts.map&#123; <span class="params">|p|</span> p.id &#125;</div><div class="line">+   @subscriptions_count = Post.where( <span class="symbol">:id</span> =&gt; post_ids).joins(<span class="symbol">:subscriptions</span>).group(<span class="string">"posts.id"</span>).count</div><div class="line">  <span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>ç¼–è¾‘ <code>app/views/posts/index.html.erb</code></p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/index.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-   &lt;td&gt;&lt;%= post.subscriptions.size %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">+   &lt;td&gt;&lt;%= @subscriptions_count[post.id] %&gt;&lt;/td</span>&gt;</div></pre></td></tr></table></figure>
<p>è§‚å¯Ÿä¸€ä¸‹ logï¼Œæˆ‘ä»¬åªç”¨ä¸€æ¡ SQL å°±å¯ä»¥è®¡ç®—è¿™ä¸€é¡µè´´æ–‡çš„æ‰€æœ‰è®¢é˜…æ•°:<br><img src="https://ww4.sinaimg.cn/large/006tNc79ly1fk8qltkggnj30w70d6t9r.jpg" alt=""></p>
<p><code>@subscriptions_count</code> è¿™ä¸ªå˜é‡æ˜¯ä¸ª Hashï¼Œé”®æ˜¯ post IDï¼Œå€¼æ˜¯è®¢é˜…æ•°ï¼Œä¾‹å¦‚ <code>{403=&gt;59, 404=&gt;89, 405=&gt;10, 406=&gt;93, 407=&gt;10, 408=&gt;47, 409=&gt;90, 410=&gt;78, 411=&gt;79, 412=&gt;43, 413=&gt;58, 414=&gt;13, 415=&gt;61, 416=&gt;76, 417=&gt;97, 418=&gt;59, 419=&gt;41, 420=&gt;68, 421=&gt;44, 422=&gt;44, 423=&gt;85, 424=&gt;95, 425=&gt;12, 426=&gt;54, 427=&gt;78}</code><br>ä¸è¿‡ï¼Œè¿™ä¸€é¡µæ˜¯æµé‡æœ€é«˜çš„é¦–é¡µï¼Œæœ‰æ²¡æœ‰åŠæ³•å¯ä»¥æ›´å¿«æ›´ç®€å•ï¼Ÿ</p>
<h4 id="è®¡æ•°ç¼“å­˜-Counter-Cache"><a href="#è®¡æ•°ç¼“å­˜-Counter-Cache" class="headerlink" title="è®¡æ•°ç¼“å­˜ (Counter Cache)"></a>è®¡æ•°ç¼“å­˜ (Counter Cache)</h4><p>åƒè¿™ç§ <code>Post has_many subscriptions</code> çš„ä¸€å¯¹å¤šå…³ç³»ï¼Œå¦‚æœç»å¸¸è¦æ˜¾ç¤ºæœ‰å¤šå°‘ç¬”æ•°æ®ï¼Œä¸å…¶æ¯æ¬¡éƒ½ç”¨ SQL è®¡ç®—ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨é€†è§„èŒƒåŒ–çš„æ¦‚å¿µï¼Œç›´æ¥æ–°å¢ä¸€ä¸ª posts çš„å­—æ®µæŠŠè®¢é˜…çš„æ•°å­—å­˜ä¸‹æ¥ï¼Œè¿™æ ·æ˜¾ç¤ºçš„æ—¶å€™ç›´æ¥å°±å¯ä»¥æ˜¾ç¤ºäº†ï¼Œä¸éœ€è¦å†è®¡ç®—ã€‚ç„¶åæ¯æ¬¡æ–°å¢æˆ–åˆ é™¤ Subscription æ—¶ï¼Œéœ€è¦è®°å¾—å»æ›´æ–°è¿™ä¸ªå€¼å³å¯ã€‚</p>
<p>Rails å†…å»ºå°±æœ‰è®¡æ•°ç¼“å­˜ (Counter Cache) çš„åŠŸèƒ½ï¼š</p>
<p>æ‰§è¡Œ <code>rails g migration add_subscriptions_to_posts</code></p>
<p>ç¼–è¾‘ <code>db/migrate/2017XXXXXXXXXX_add_subscriptions_to_posts.rb</code>ï¼Œæ–°å¢ä¸€ä¸ªå­—æ®µ <code>subscriptions_count</code> åˆ° posts ä¸Šï¼Œè¡¨ç¤ºè¿™ç¯‡è´´æ–‡æœ‰å¤šå°‘è®¢é˜…æ•°ï¼š</p>
<figure class="highlight ruby"><figcaption><span>db/migrate/2017XXXXXXXXXX_add_subscriptions_to_posts.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">AddSubscriptionsToPosts</span> &lt; ActiveRecord::Migration[5.1]</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">change</span></span></div><div class="line"></div><div class="line">+    add_column <span class="symbol">:posts</span>, <span class="symbol">:subscriptions_count</span>, <span class="symbol">:integer</span>, <span class="symbol">:default</span> =&gt; <span class="number">0</span></div><div class="line"></div><div class="line">+    Post.pluck(<span class="symbol">:id</span>).each <span class="keyword">do</span> <span class="params">|i|</span></div><div class="line">+      Post.reset_counters(i, <span class="symbol">:subscriptions</span>) <span class="comment"># åˆšæ–°å¢çš„å­—æ®µéƒ½æ˜¯ 0ï¼Œéœ€è¦å°†è®¡æ•°å…¨éƒ¨é‡ç®—ä¸€æ¬¡</span></div><div class="line">+    <span class="keyword">end</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>ç¼–è¾‘ <code>app/models/subscription.rb</code>ï¼ŒåŠ ä¸Š <code>counter_cache</code>ï¼Œè¿™ä¼šå‘Šè¯‰ Rails å¦‚æœæœ‰æ–°å¢æˆ–åˆ é™¤ Subscription æ—¶ï¼Œè‡ªåŠ¨å»æ›´æ–° Post çš„ <code>subscriptions_count</code> æ•°å­—ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/models/subscription.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-   belongs_to <span class="symbol">:post</span></div><div class="line">+   belongs_to <span class="symbol">:post</span>, <span class="symbol">:counter_cache</span> =&gt; <span class="literal">true</span></div><div class="line"></div><div class="line">    <span class="comment"># æˆ– belongs_to :post, :counter_cache =&gt; "subscriptions_count"</span></div></pre></td></tr></table></figure>
<p>æ‰§è¡Œ <code>rake db:migrate</code></p>
<p>ä¿®æ”¹ <code>app/views/posts/index.html.erb</code>ï¼Œç›´æ¥æ˜¾ç¤ºè¿™ä¸ªæ•°å­—ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/index.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-  &lt;td&gt;&lt;%= @subscriptions_count[post.id] %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">+  &lt;td&gt;&lt;%= post.subscriptions_count %&gt;&lt;/td</span>&gt;</div></pre></td></tr></table></figure>
<p>ä¿®æ”¹ <code>app/controllers/posts_controller.rb</code>ï¼Œä¸éœ€è¦å†è®¡ç®—è®¢é˜…æ•°äº†ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/controllers/posts_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">index</span></span></div><div class="line">    @posts = Post.includes(<span class="symbol">:user</span>, <span class="symbol">:liked_users</span>, &#123; <span class="symbol">:visible_comments</span> =&gt; <span class="symbol">:user</span> &#125; ).page(params[<span class="symbol">:page</span>])</div><div class="line"></div><div class="line">-   post_ids = @posts.map&#123; <span class="params">|p|</span> p.id &#125;</div><div class="line">-   @subscriptions_count = Post.where( <span class="symbol">:id</span> =&gt; post_ids).joins(<span class="symbol">:subscriptions</span>).group(<span class="string">"posts.id"</span>).count</div><div class="line">  <span class="keyword">end</span></div></pre></td></tr></table></figure>
<blockquote>
<p>Rails å†…å»ºçš„ Counter Cache åŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œå¦‚æœä½ éœ€è¦æ›´å¤šåŠŸèƒ½ï¼Œè¯·å‚è€ƒ <a href="https://github.com/magnusvk/counter_culture" target="_blank" rel="external">https://github.com/magnusvk/counter_culture</a> è¿™ä¸ª gemã€‚</p>
</blockquote>
<h4 id="å†ä¸€ä¸ªé€†è§„èŒƒåŒ–çš„ä¾‹å­"><a href="#å†ä¸€ä¸ªé€†è§„èŒƒåŒ–çš„ä¾‹å­" class="headerlink" title="å†ä¸€ä¸ªé€†è§„èŒƒåŒ–çš„ä¾‹å­"></a>å†ä¸€ä¸ªé€†è§„èŒƒåŒ–çš„ä¾‹å­</h4><p>éœ€æ±‚æƒ…å¢ƒï¼šåœ¨ posts index é¡µé¢ä¸Šï¼Œæ˜¾ç¤ºæ¯ç¯‡è´´æ–‡çš„æœ€åè®¢é˜…çš„æ—¶é—´</p>
<p>é€†è§„èŒƒåŒ–è§£æ³•ï¼š</p>
<ol>
<li>åœ¨ posts table ä¸Šæ–°å¢ä¸€ä¸ªä¸€ä¸ª last_subscribed_at æ—¶é—´å­—æ®µ</li>
<li>åœ¨æœ‰äººè®¢é˜…æ—¶ï¼Œä¾‹å¦‚ subscriptions controller çš„ create action ä¸­ï¼Œå»æ›´æ–°è¯¥ç¯‡ post çš„ last_subscribed_at å€¼</li>
<li>åœ¨æœ‰äººå–æ¶ˆè®¢é˜…æ—¶ï¼Œä¾‹å¦‚ subscriptions controller çš„ destroy action ä¸­ï¼Œå»æ›´æ–°è¯¥ç¯‡ post çš„ last_subscribed_at å€¼</li>
</ol>
<p>è·Ÿ Counter Cache æ¦‚å¿µä¸€æ ·ï¼Œåªæ˜¯å®ä½œéº»çƒ¦ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åœ¨æ­£ç¡®çš„æ—¶æœºå»ç»´æŠ¤ <code>last_subscribed_at</code> çš„å€¼</p>
<h4 id="å°ç»“è®ºï¼šä»€ä¹ˆæ—¶å€™ç”¨é€†è§„èŒƒåŒ–åšä¼˜åŒ–ï¼Ÿ"><a href="#å°ç»“è®ºï¼šä»€ä¹ˆæ—¶å€™ç”¨é€†è§„èŒƒåŒ–åšä¼˜åŒ–ï¼Ÿ" class="headerlink" title="å°ç»“è®ºï¼šä»€ä¹ˆæ—¶å€™ç”¨é€†è§„èŒƒåŒ–åšä¼˜åŒ–ï¼Ÿ"></a>å°ç»“è®ºï¼šä»€ä¹ˆæ—¶å€™ç”¨é€†è§„èŒƒåŒ–åšä¼˜åŒ–ï¼Ÿ</h4><p>å¦‚æœä¸å¸¸æ˜¾ç¤ºè¯¥æ•°æ®ï¼Œè€Œä¸”ä½ ä¼šå†™ SQL åšè®¡ç®—çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨çº¯ SQL çš„æ–¹å¼æ¥è§£å†³ã€‚ä½†æ˜¯å¦‚æœéœ€è¦ç»å¸¸æ˜¾ç¤ºè¯¥æ•°æ®ï¼Œå°±å¯ä»¥è€ƒè™‘ç”¨é€†è§„èŒƒåŒ–çš„æ–¹å¼ï¼Œå°†æ•°æ®ç¼“å­˜ä¸‹æ¥ã€‚è¿™æ ·æ•ˆèƒ½å¯ä»¥æ›´å¥½ã€‚ä½†æ˜¯ç¼ºç‚¹å°±æ˜¯éœ€è¦ç»´æŠ¤è¯¥æ•°æ®çš„æ­£ç¡®æ€§ï¼Œè¦å†™çš„ Ruby ä»£ç ä¹Ÿæ¯”è¾ƒå¤šã€‚</p>
<p>è€ƒé‡ï¼š<strong>è¯»å–çš„é¢‘ç‡ v.s. æ›´æ–°ç¼“å­˜æ•°æ®çš„æˆæœ¬</strong></p>
<h3 id="3-æ”¹è¿›-Render-Partial-çš„æ•ˆèƒ½"><a href="#3-æ”¹è¿›-Render-Partial-çš„æ•ˆèƒ½" class="headerlink" title="3. æ”¹è¿› Render Partial çš„æ•ˆèƒ½"></a>3. æ”¹è¿› Render Partial çš„æ•ˆèƒ½</h3><p>è¿™ä¸ªæ˜¯å¸¸ç”¨çš„æŠ€å·§ã€‚<br>è¿™ä¸€ç« è®©æˆ‘ä»¬çœ‹ä¸€ä¸ª Rails View çš„æ•ˆèƒ½æ”¹å–„ï¼Œæƒ…å¢ƒæ˜¯å½“åŒä¸€ä¸ª partial éœ€è¦ä¸æ–­ render æ—¶ï¼Œå¯ä»¥æ”¹ç”¨<strong> collection çš„å†™æ³•</strong>ï¼Œæ•ˆèƒ½ä¼šæ›´å¥½ã€‚</p>
<p>ä¾‹å¦‚æˆ‘ä»¬å°† index é¡µé¢ä¸­æ¯ä¸€ç¬” post æ”¹æˆç”¨ partial å¤„ç†ï¼š</p>
<p>ä¿®æ”¹ <code>app/views/posts/index.html.erb</code></p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/index.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">  &lt;% @posts.each <span class="keyword">do</span> <span class="params">|post|</span> %&gt;</div><div class="line">-    &lt;tr&gt;</div><div class="line">-      &lt;td&gt;</div><div class="line">-        &lt;% <span class="keyword">if</span> current_user &amp;&amp; current_user.like_post?(post) %&gt;</div><div class="line">-          ğŸ‘ğŸ‘ğŸ‘</div><div class="line">-        &lt;% <span class="keyword">end</span> %&gt;</div><div class="line">-        &lt;%= link_to post.title, post_path(post) %&gt;</div><div class="line">-      &lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">-      &lt;td&gt;&lt;%= post.user.display_name %&gt;&lt;/td</span>&gt;</div><div class="line">-      &lt;td&gt;&lt;%= post.visible_comments.size %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">-      &lt;td&gt;&lt;%= post.subscriptions_count %&gt;&lt;/td</span>&gt;</div><div class="line">-      &lt;td&gt;&lt;%= post.visible_comments.map&#123; <span class="params">|c|</span> c.user.display_name &#125;.join(<span class="string">","</span>) %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">-      &lt;td&gt;&lt;%= post.liked_users.map&#123; |u| u.display_name &#125;.join(",") %&gt;&lt;/td</span>&gt;</div><div class="line">-    &lt;<span class="regexp">/tr&gt;</span></div><div class="line"><span class="regexp">+    &lt;%= render :partial =&gt; "post", :locals =&gt; &#123; :post =&gt; post &#125; %&gt;</span></div><div class="line"><span class="regexp">  &lt;% end %&gt;</span></div></pre></td></tr></table></figure>
<p>æ–°å¢ <code>app/views/posts/_post.html.erb</code></p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/_post.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;tr&gt;</div><div class="line">  &lt;td&gt;</div><div class="line">    &lt;% <span class="keyword">if</span> current_user &amp;&amp; current_user.like_post?(post) %&gt;</div><div class="line">      ğŸ‘ğŸ‘ğŸ‘</div><div class="line">    &lt;% <span class="keyword">end</span> %&gt;</div><div class="line">    &lt;%= link_to post.title, post_path(post) %&gt;</div><div class="line">  &lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">  &lt;td&gt;&lt;%= post.user.display_name %&gt;&lt;/td</span>&gt;</div><div class="line">  &lt;td&gt;&lt;%= post.visible_comments.size %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">  &lt;td&gt;&lt;%= post.subscriptions_count %&gt;&lt;/td</span>&gt;</div><div class="line">  &lt;td&gt;&lt;%= post.visible_comments.map&#123; <span class="params">|c|</span> c.user.display_name &#125;.join(<span class="string">","</span>) %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">  &lt;td&gt;&lt;%= post.liked_users.map&#123; |u| u.display_name &#125;.join(",") %&gt;&lt;/td</span>&gt;</div><div class="line">&lt;<span class="regexp">/tr&gt;</span></div></pre></td></tr></table></figure>
<p>çœ‹ä¸€ä¸‹ logï¼Œå…¶ä¸­ä¸æ–­è°ƒç”¨ <code>Rendered posts/_post.html.erb</code> è¿™ä¸ª partial æ ·æ¿ï¼š<br><img src="https://ww4.sinaimg.cn/large/006tNc79gy1fk8qtcat0rj30wa0qhab5.jpg" alt=""></p>
<p>æ€ä¹ˆæ”¹è¿›å‘¢ï¼ŸRails é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæœ‰æä¾›ä¸€ä¸ªä¼˜åŒ–çš„å†™æ³•ï¼Œå†æ¬¡ç¼–è¾‘ <code>app/views/posts/index.html.erb</code>ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/index.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">-  &lt;% @posts.each <span class="keyword">do</span> <span class="params">|post|</span> %&gt;</div><div class="line">-    &lt;%= render <span class="symbol">:partial</span> =&gt; <span class="string">"post"</span>, <span class="symbol">:locals</span> =&gt; &#123; <span class="symbol">:post</span> =&gt; post &#125; %&gt;</div><div class="line">-  &lt;% <span class="keyword">end</span> %&gt;</div><div class="line"></div><div class="line">+  &lt;%= render <span class="symbol">:partial</span> =&gt; <span class="string">"post"</span>, <span class="symbol">:collection</span> =&gt; @posts, <span class="symbol">:as</span> =&gt;</div><div class="line">  <span class="symbol">:post</span> %&gt;</div></pre></td></tr></table></figure>
<p>æ•´ä¸ª <code>@posts.each</code> å¾ªç¯éƒ½æ‹¿æ‰äº†ï¼Œæ–°çš„ <code>:collection</code> å‚æ•°å°±ä¼šå¸®ä½ åšå¾ªç¯ã€‚</p>
<p><img src="https://ww4.sinaimg.cn/large/006tNc79gy1fk8qtgcae0j30wc0cg3ze.jpg" alt=""><br>ä¸ºä»€ä¹ˆè¿™ç§ç”¨æ³•ä¼šæ¯”è¾ƒå¿«å‘¢ï¼Ÿæœ¬æ¥çš„å†™æ³• Rails éœ€è¦é’ˆå¯¹æ¯ä¸ª partial éƒ½åšä¸€æ¬¡ç¼–è¯‘å¤„ç†ï¼Œæ–°çš„å†™æ³• Rails çŸ¥é“è¿™äº› partial åŸæ¥æ˜¯åŒä¸€ä¸ª partialï¼Œå› æ­¤åªéœ€è¦ç¼–è¯‘å¤„ç†ä¸€æ¬¡ã€‚</p>
<h3 id="4-æ•°æ®åº“ç´¢å¼•"><a href="#4-æ•°æ®åº“ç´¢å¼•" class="headerlink" title="4. æ•°æ®åº“ç´¢å¼•"></a>4. æ•°æ®åº“ç´¢å¼•</h3><p>åœ¨æ•°æ®åº“æ•™ç¨‹ä¸­(åœ¨ SQL è¯­è¨€: DML è¿™ä¸€ç« æœ€åä¸€èŠ‚)ï¼Œæˆ‘ä»¬æœ‰æåˆ°åŠ ä¸Š Indexes ç´¢å¼•çš„é‡è¦ï¼Œ<strong>å¿˜è®°å¸®æ•°æ®åº“åŠ ä¸Šç´¢å¼•ä¹Ÿæ˜¯å¸¸è§çš„æ•ˆèƒ½æ€æ‰‹</strong>ï¼Œä½œä¸ºæœå¯»æ¡ä»¶çš„å­—æ®µå¦‚æœæ²¡æœ‰åŠ ç´¢å¼•ï¼ŒSQL æŸ¥è¯¢çš„æ—¶å€™å°±ä¼šä¸€ç¬”ç¬”æ£€æŸ¥èµ„æ–™è¡¨ä¸­çš„æ‰€æœ‰èµ„æ–™ï¼Œå½“èµ„æ–™ä¸€å¤šçš„æ—¶å€™ç›¸å·®çš„æ•ˆèƒ½å°±ååˆ†å·¨å¤§ï¼Œæ²¡ç´¢å¼•æ˜¯ O(N)ï¼Œæœ‰ç´¢å¼•æ˜¯ O(logN)ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œä»¥ä¸‹çš„å­—æ®µéƒ½å¿…é¡»è®°å¾—åŠ ä¸Šç´¢å¼•ï¼š</p>
<ul>
<li>å¤–éƒ¨é”®(Foreign key)</li>
<li>ä¼šè¢«æ’åºçš„å­—æ®µ(è¢«æ”¾åœ¨orderæ–¹æ³•ä¸­)</li>
<li>ä¼šè¢«æŸ¥è¯¢çš„å­—æ®µ(è¢«æ”¾åœ¨whereæ–¹æ³•ä¸­)</li>
<li>ä¼šè¢«groupçš„å­—æ®µ(è¢«æ”¾åœ¨groupæ–¹æ³•ä¸­)</li>
</ul>
<p>è®©æˆ‘ä»¬è¡¥ä¸Šå¿˜è®°çš„ç´¢å¼•ï¼š</p>
<p>æ‰§è¡Œ <code>rails g migration add_indexes</code></p>
<p>ç¼–è¾‘ <code>db/migrate/20170XXXXXXXXX_add_indexes.rb</code></p>
<figure class="highlight ruby"><figcaption><span>db/migrate/20170XXXXXXXXX_add_indexes.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">AddIndexes</span> &lt; ActiveRecord::Migration[5.1]</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">change</span></span></div><div class="line">+     add_index <span class="symbol">:comments</span>, <span class="symbol">:status</span></div><div class="line">+     add_index <span class="symbol">:comments</span>, <span class="symbol">:post_id</span></div><div class="line">+     add_index <span class="symbol">:likes</span>, <span class="symbol">:post_id</span></div><div class="line">+     add_index <span class="symbol">:likes</span>, <span class="symbol">:user_id</span></div><div class="line">+</div><div class="line">+     add_index <span class="symbol">:subscriptions</span>, <span class="symbol">:post_id</span></div><div class="line">+     add_index <span class="symbol">:subscriptions</span>, <span class="symbol">:user_id</span></div><div class="line">    <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>æ‰§è¡Œ <code>rake db:migrate</code></p>
<h4 id="å¸¸è§çš„æ•ˆèƒ½é”™è¯¯"><a href="#å¸¸è§çš„æ•ˆèƒ½é”™è¯¯" class="headerlink" title="å¸¸è§çš„æ•ˆèƒ½é”™è¯¯"></a>å¸¸è§çš„æ•ˆèƒ½é”™è¯¯</h4><p>ä¸€ä¸ªå¸¸çŠ¯çš„é”™è¯¯æ˜¯ç”¨ <code>created_at</code> æ¥è¿›è¡Œæ’åºï¼Œä¾‹å¦‚æƒ³è¦ä¾ç…§æ–°å»ºæ—¶é—´æ’åºï¼Œè®©æ–°çš„è´´æ–‡åœ¨ä¸Šé¢ï¼š</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@posts</span> = Post.order(<span class="string">"created_at DESC"</span>).page(params[<span class="symbol">:page</span>])</div></pre></td></tr></table></figure>
<p>ç”±äº <code>created_at</code> è¿™ä¸ªå­—æ®µæˆ‘ä»¬å¹¶æ²¡æœ‰åŠ ä¸Šç´¢å¼•ï¼Œå¦‚æœä½ åªæ˜¯æƒ³è¦æ’åºï¼Œåº”è¯¥æ”¹ç”¨ id å­—ä¸²ï¼š</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@posts</span> = Post.order(<span class="string">"id DESC"</span>).page(params[<span class="symbol">:page</span>])</div></pre></td></tr></table></figure>
<p>å› ä¸º<code>id</code>æ˜¯ä¸»é”®æœ¬èº«å°±æœ‰ç´¢å¼•ï¼Œè€Œä¸”å®ƒæ˜¯è‡ªåŠ¨é€’å¢çš„æ•°å­—ã€‚æ‰€ä»¥æ ¹æ® <code>id</code> æ¥æ’åºå’Œæ ¹æ® <code>created_at</code> æ¥æ’åºç»“æœæ˜¯ä¸€æ ·çš„ã€‚</p>
<h4 id="SQL-explain-æœºåˆ¶"><a href="#SQL-explain-æœºåˆ¶" class="headerlink" title="SQL explain æœºåˆ¶"></a>SQL explain æœºåˆ¶</h4><p>å¯¹ä¸€ä¸ªå¤æ‚çš„ SQL æŸ¥è¯¢æ¥è¯´ï¼Œæœ‰æ²¡æœ‰ç´¢å¼•åˆ°åº•æœ‰æ²¡æœ‰æ´¾ä¸Šç”¨åœºï¼ŸSQL åœ¨æ•°æ®åº“ä¸­åˆ°åº•æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Ÿéœ€è¦å®é™…ç”¨æ•°æ®åº“è¿›è¡Œåˆ†ææ‰ä¼šçŸ¥é“ã€‚</p>
<p><code>explain</code> è¿™ä¸ªæ–¹æ³•å¯ä»¥è°ƒç”¨æ•°æ®åº“çš„åˆ†ææŠ¥å‘Šï¼š</p>
<p><img src="https://ww4.sinaimg.cn/large/006tNc79ly1fk8rg9fdm4j30w40cm3z8.jpg" alt=""><br>ä¸åŒç§çš„æ•°æ®åº“(SQLiteã€PostgreSQLã€MySQL)çš„æŠ¥å‘Šæ ¼å¼ä¸ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸ç»†è¯´äº†ã€‚</p>
<h3 id="5-åç«¯ç¼“å­˜å’Œå»¶å±•æ€§-Scalability"><a href="#5-åç«¯ç¼“å­˜å’Œå»¶å±•æ€§-Scalability" class="headerlink" title="5. åç«¯ç¼“å­˜å’Œå»¶å±•æ€§(Scalability)"></a>5. åç«¯ç¼“å­˜å’Œå»¶å±•æ€§(Scalability)</h3><h4 id="å†…å­˜ç¼“å­˜"><a href="#å†…å­˜ç¼“å­˜" class="headerlink" title="å†…å­˜ç¼“å­˜"></a>å†…å­˜ç¼“å­˜</h4><p>è¶…é«˜æµé‡çš„ç½‘ç«™ä¼šéœ€è¦ç”¨åˆ°ç¼“å­˜æ¥è¿›ä¸€æ­¥æå‡åç«¯æ•ˆèƒ½ã€‚<br>ihowerè€å¸ˆçš„<a href="https://ihower.tw/rails/caching-cn.html" target="_blank" rel="external">Rails å®æˆ˜åœ£ç»:ç¼“å­˜</a>ã€‚</p>
<blockquote>
<p>No code is faster than no code. - Merb core tenet</p>
</blockquote>
<h4 id="ç½‘ç«™å»¶å±•æ€§"><a href="#ç½‘ç«™å»¶å±•æ€§" class="headerlink" title="ç½‘ç«™å»¶å±•æ€§"></a>ç½‘ç«™å»¶å±•æ€§</h4><p>å¦ä¸€ä¸ªè·Ÿã€Œç½‘ç«™æ•ˆèƒ½(Performance)ã€å¸¸ä¸€èµ·å¬åˆ°çš„åè¯æ˜¯ã€Œç½‘ç«™å»¶å±•æ€§(Scalability)ã€ã€‚å½“ç½‘ç«™çš„ç”¨æˆ·è¶Šæ¥è¶Šå¤šï¼Œæµé‡è¶Šæ¥è¶Šå¤§çš„æ—¶å€™ï¼Œéœ€è¦æƒ³åŠæ³•æ‰©å±•ç½‘ç«™çš„æ‰¿è½½èƒ½åŠ›ã€‚</p>
<p>æ‰©å±•çš„æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ol>
<li>å‚ç›´æ‰©å±•ï¼šå‡çº§æœåŠ¡å™¨ï¼Œä¾‹å¦‚ç”¨æ›´å¿«çš„ CPUã€ç”¨å¤§çš„ç¡¬ç›˜ã€ç”¨å¤šçš„å†…å­˜</li>
<li>æ°´å¹³æ‰©å±•ï¼šå¢åŠ (ç§Ÿç”¨)æ›´å¤šæœåŠ¡å™¨</li>
</ol>
<p><img src="https://ww3.sinaimg.cn/large/006tNc79gy1fk8rchwo27j308w056wev.jpg" alt=""><br>å‚ç›´æ‰©å±•åœ¨åˆæœŸæ¯”è¾ƒç®€å•ï¼Œå› ä¸ºç½‘ç«™ä»£ç ä¸éœ€è¦å˜æ›´ï¼Œåªéœ€è¦åŸåœ°ç¡¬ä»¶å‡çº§å³å¯ã€‚ä½†æ˜¯ç¡¬ä»¶å‡çº§æ˜¯æœ‰ä¸Šé™çš„ï¼Œè¶Šé«˜ç­‰çº§çš„æœåŠ¡å™¨è¶Šè´µã€‚CPU å†æ€ä¹ˆå¿«ï¼Œæ€»ä¸å¯èƒ½æˆ‘ä»¬å»ç§Ÿä¸€å°è¶…çº§ç”µè„‘å§ã€‚</p>
<p>æ°´å¹³æ‰©å±•åˆ™æ¯”è¾ƒåˆä¹æˆæœ¬ï¼Œå› ä¸ºä¸€ç™¾å°å¹³ä»·çš„ç”µè„‘ï¼Œæ¯”èµ·ä¸€å°è¶…çº§ç”µè„‘è¿˜ä¾¿å®œã€‚ä½†æ˜¯æ°´å¹³æ‰©å±•ä¼šéœ€è¦ç½‘ç«™æ¶æ„çš„è¿ç»´èƒ½åŠ›ï¼Œå¯¹æŠ€æœ¯çš„è¦æ±‚æ¯”è¾ƒé«˜ã€‚</p>
<p>å¸¸è§çš„ç½‘ç«™æ¶æ„æ¼”è¿›ï¼Œè¯·å‚è€ƒ <a href="https://www.digitalocean.com/community/tutorials/5-common-server-setups-for-your-web-application" target="_blank" rel="external">5 Common Server Setups For Your Web Application</a> è¿™ç¯‡æ–‡ç« çš„å›¾ä¾‹ï¼š<br><img src="https://ww2.sinaimg.cn/large/006tNc79gy1fk8rctxremj308j054dfq.jpg" alt=""></p>
<p>ä¸€å¼€å§‹åªéœ€è¦ä¸€å°æœåŠ¡å™¨<br><img src="https://ww1.sinaimg.cn/large/006tNc79gy1fk8rd423iwj30dq05cdfu.jpg" alt=""></p>
<p>æ¥ä¸‹æ¥å°†æ•°æ®åº“ç‹¬ç«‹æˆä¸€å°æœåŠ¡å™¨<br><img src="https://ww1.sinaimg.cn/large/006tNc79gy1fk8rdern5mj30i007mjrf.jpg" alt=""></p>
<p>å‰é¢æ”¾ä¸€å° Load Balancer æœåŠ¡å™¨åˆ†æ•£æµé‡ï¼Œè¿™æ ·å¢åŠ æ›´å¤šå°åº”ç”¨æœåŠ¡å™¨(Application serverï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„ Rails server)<br><img src="https://ww3.sinaimg.cn/large/006tNc79gy1fk8rdui9vxj30j305zdfv.jpg" alt=""></p>
<p>å‰é¢å†æ”¾ HTTP ç¼“å­˜æœåŠ¡å™¨</p>
<p><img src="https://ww3.sinaimg.cn/large/006tNc79gy1fk8re94najj30hg07maa6.jpg" alt=""><br>æ•°æ®åº“ä¹Ÿéœ€è¦æ‹†åˆ†ï¼Œå¯ä»¥åˆ†æˆ Master å’Œ Slave æ•°æ®åº“ï¼Œè¯»å†™åˆ†ç¦»ã€‚</p>
<p>ä»¥ä¸Šæ˜¯è¿˜ç®—æ˜¯å…¥é—¨ç­‰çº§çš„æ¶æ„ï¼Œè¦ç»§ç»­å»¶å±•çš„è¯ï¼Œå°±æ˜¯å¦ä¸€é—¨æ·±ä¼¼æµ·çš„å­¦é—®äº†ã€‚ç½‘ç«™çš„å»¶å±•æ€§ï¼Œå°±æ˜¯å»ç ”ç©¶å¦‚ä½•åœ¨åˆç†çš„ç¡¬ä»¶æˆæœ¬ä¸‹ï¼Œé€è¿‡æ°´å¹³æ‰©å±•æŒç»­å¢åŠ ç³»ç»Ÿå®¹é‡ã€‚è¿™ä»¶äº‹æƒ…è·Ÿ Rails æŠ€æœ¯å°±æ¯”è¾ƒæ²¡æœ‰å…³ç³»äº†ã€‚</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Ruby-on-Rails/">Ruby on Rails</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/æ–°ç”Ÿå¤§å­¦å…¨æ ˆè¥/">æ–°ç”Ÿå¤§å­¦å…¨æ ˆè¥</a><a href="/tags/Ruby-on-Rails/">Ruby on Rails</a><a href="/tags/å…¨æ ˆè¥è¯¾ç¨‹å¤ç›˜/">å…¨æ ˆè¥è¯¾ç¨‹å¤ç›˜</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://kerzzi.github.io/2017/10/06/2017-10-06-rails-website-performance-03/" data-title="è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ3ï¼‰ | æŸ¯å­çš„è¡Œæ€ç¬”è®°" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/10/07/2017-10-07-rails-jdstore-02/" title="è¯¾ç¨‹å¤ç›˜ | Rails å®æˆ˜ï¼šè´­ç‰©ç½‘ç«™ï¼ˆ2ï¼‰">
  <strong>ä¸Šä¸€ç¯‡ï¼š</strong><br/>
  <span>
  è¯¾ç¨‹å¤ç›˜ | Rails å®æˆ˜ï¼šè´­ç‰©ç½‘ç«™ï¼ˆ2ï¼‰</span>
</a>
</div>


<div class="next">
<a href="/2017/10/06/2017-10-06-rails-website-performance-02/"  title="è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ2ï¼‰">
 <strong>ä¸‹ä¸€ç¯‡ï¼š</strong><br/> 
 <span>è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ2ï¼‰
</span>
</a>
</div>

</nav>

	


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">æ–‡ç« ç›®å½•</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#è¯¾ç¨‹ç›®æ ‡"><span class="toc-number">1.</span> <span class="toc-text">è¯¾ç¨‹ç›®æ ‡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#è¯¾ç¨‹å¤ç›˜"><span class="toc-number">2.</span> <span class="toc-text">è¯¾ç¨‹å¤ç›˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-æ•°æ®åº“-SQL-ä¼˜åŒ–"><span class="toc-number">2.1.</span> <span class="toc-text">1. æ•°æ®åº“ SQL ä¼˜åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-è®¡æ•°ç¼“å­˜-Counter-Cache"><span class="toc-number">2.2.</span> <span class="toc-text">2. è®¡æ•°ç¼“å­˜ (Counter Cache)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#è®¡æ•°ç¼“å­˜-Counter-Cache"><span class="toc-number">2.2.1.</span> <span class="toc-text">è®¡æ•°ç¼“å­˜ (Counter Cache)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å†ä¸€ä¸ªé€†è§„èŒƒåŒ–çš„ä¾‹å­"><span class="toc-number">2.2.2.</span> <span class="toc-text">å†ä¸€ä¸ªé€†è§„èŒƒåŒ–çš„ä¾‹å­</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å°ç»“è®ºï¼šä»€ä¹ˆæ—¶å€™ç”¨é€†è§„èŒƒåŒ–åšä¼˜åŒ–ï¼Ÿ"><span class="toc-number">2.2.3.</span> <span class="toc-text">å°ç»“è®ºï¼šä»€ä¹ˆæ—¶å€™ç”¨é€†è§„èŒƒåŒ–åšä¼˜åŒ–ï¼Ÿ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-æ”¹è¿›-Render-Partial-çš„æ•ˆèƒ½"><span class="toc-number">2.3.</span> <span class="toc-text">3. æ”¹è¿› Render Partial çš„æ•ˆèƒ½</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-æ•°æ®åº“ç´¢å¼•"><span class="toc-number">2.4.</span> <span class="toc-text">4. æ•°æ®åº“ç´¢å¼•</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å¸¸è§çš„æ•ˆèƒ½é”™è¯¯"><span class="toc-number">2.4.1.</span> <span class="toc-text">å¸¸è§çš„æ•ˆèƒ½é”™è¯¯</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL-explain-æœºåˆ¶"><span class="toc-number">2.4.2.</span> <span class="toc-text">SQL explain æœºåˆ¶</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-åç«¯ç¼“å­˜å’Œå»¶å±•æ€§-Scalability"><span class="toc-number">2.5.</span> <span class="toc-text">5. åç«¯ç¼“å­˜å’Œå»¶å±•æ€§(Scalability)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å†…å­˜ç¼“å­˜"><span class="toc-number">2.5.1.</span> <span class="toc-text">å†…å­˜ç¼“å­˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ç½‘ç«™å»¶å±•æ€§"><span class="toc-number">2.5.2.</span> <span class="toc-text">ç½‘ç«™å»¶å±•æ€§</span></a></li></ol></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="éšè—ä¾§è¾¹æ "></a></div>
<aside class="clearfix">

  <div class="sponsor">
  <br />
  <p class="asidetitle">èµåŠ©å•†</p>
  <a href="/sponsor">
  <br />
  <img src="https://ww2.sinaimg.cn/large/006tNc79ly1fk2zsxnnmpj30b405iq2t.jpg" width="235px" />
  </a>

  <!--
  <br /><a href="/sponsor"><font color='#2ca6cb'>è´­ä¹°å¹¿å‘Šä½</font></a>
  -->
</div>

  
<div class="categorieslist">
	<p class="asidetitle">åˆ†ç±»</p>
		<ul>
		
		  
			<li><a href="/categories/Github/" title="Github">Github</a></li>
		  
		
		  
			<li><a href="/categories/Mac/" title="Mac">Mac</a></li>
		  
		
		  
			<li><a href="/categories/Markdown/" title="Markdown">Markdown</a></li>
		  
		
		  
			<li><a href="/categories/Meetup/" title="Meetup">Meetup</a></li>
		  
		
		  
			<li><a href="/categories/ORID/" title="ORID">ORID</a></li>
		  
		
		  
			<li><a href="/categories/Photo/" title="Photo">Photo</a></li>
		  
		
		  
			<li><a href="/categories/Ruby-on-Rails/" title="Ruby on Rails">Ruby on Rails</a></li>
		  
		
		  
			<li><a href="/categories/Ruby-on-rails/" title="Ruby on rails">Ruby on rails</a></li>
		  
		
		  
			<li><a href="/categories/freeCodeCamp/" title="freeCodeCamp">freeCodeCamp</a></li>
		  
		
		  
			<li><a href="/categories/git/" title="git">git</a></li>
		  
		
		  
			<li><a href="/categories/ä¸¤æœ€ä¸€å‘/" title="ä¸¤æœ€ä¸€å‘">ä¸¤æœ€ä¸€å‘</a></li>
		  
		
		  
			<li><a href="/categories/å…ƒå­¦ä¹ /" title="å…ƒå­¦ä¹ ">å…ƒå­¦ä¹ </a></li>
		  
		
		  
			<li><a href="/categories/å…¨æ ˆè¥/" title="å…¨æ ˆè¥">å…¨æ ˆè¥</a></li>
		  
		
		  
			<li><a href="/categories/å…³äºå†™ä½œ/" title="å…³äºå†™ä½œ">å…³äºå†™ä½œ</a></li>
		  
		
		  
			<li><a href="/categories/åŒºå—é“¾/" title="åŒºå—é“¾">åŒºå—é“¾</a></li>
		  
		
		  
			<li><a href="/categories/å–„ç”¨ä½³è½¯/" title="å–„ç”¨ä½³è½¯">å–„ç”¨ä½³è½¯</a></li>
		  
		
		  
			<li><a href="/categories/ç›´æ’­ç¬”è®°/" title="ç›´æ’­ç¬”è®°">ç›´æ’­ç¬”è®°</a></li>
		  
		
		  
			<li><a href="/categories/é€šå¾€è´¢å¯Œè‡ªç”±ä¹‹è·¯/" title="é€šå¾€è´¢å¯Œè‡ªç”±ä¹‹è·¯">é€šå¾€è´¢å¯Œè‡ªç”±ä¹‹è·¯</a></li>
		  
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">å‹æƒ…é“¾æ¥</p>
    <ul>
        
          <li>
            
            	<a href="https://steemit.com/@seeyoo" target="_blank" title="Kerzzi&#39;s Steem">Kerzzi&#39;s Steem</a>
            
          </li>
        
          <li>
            
            	<a href="http://kerzzi.logdown.com/" target="_blank" title="Old Blog">Old Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://github.com/Kerzzi" target="_blank" title="Kerzzi&#39;s Github">Kerzzi&#39;s Github</a>
            
          </li>
        
          <li>
            
            	<a href="http://mindhacks.cn/" target="_blank" title="åˆ˜æœªé¹">åˆ˜æœªé¹</a>
            
          </li>
        
          <li>
            
            	<a href="https://coolshell.cn/" target="_blank" title="é…·å£³">é…·å£³</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.ruanyifeng.com/" target="_blank" title="é˜®ä¸€å³°">é˜®ä¸€å³°</a>
            
          </li>
        
    </ul>
</div>

  <div class="weixin">
  <br />
  <p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·</p>
  <p>å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œå«æˆ‘æŸ¯å­å°±å¥½ã€ï¼Œä¸ä½ åˆ†äº«å…³äºå®è·µçš„é«˜é¢‘å°å¥—è·¯ï¼š</p>
  <img src="https://ww2.sinaimg.cn/large/006tNc79ly1fk2yv4g9d3j3076076wel.jpg" width="220px" />
 </div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS è®¢é˜…</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> Â© 2017 
		
		<a href="/about" target="_blank" title="Kerzzi">Kerzzi</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="å¾®ä¿¡"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="äººäºº"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="å¾®åš"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?61e2f14c0f84a3ab81a328239a38b6d8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="è¿”å›é¡¶éƒ¨"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
