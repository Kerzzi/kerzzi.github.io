
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ2ï¼‰ | æŸ¯å­çš„è¡Œæ€ç¬”è®°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Kerzzi">
    

    
    <meta name="description" content="è¯¾ç¨‹ç›®æ ‡ Part 1: å‰è¨€ ç½‘ç«™æ•ˆèƒ½åŸºç¡€æ¦‚å¿µ   Part 2: å‰ç«¯æ•ˆèƒ½ å‰ç«¯æ•ˆèƒ½åˆ†æ å‡å°‘ Requests æ•°é‡å’Œå¤§å° HTTP æœ€ä½³åŒ– å…³é”®æ¸²æŸ“è·¯å¾„ CDN   Part 3: åç«¯æ•ˆèƒ½ é¡¹ç›®å‡†å¤‡ åç«¯æ•ˆèƒ½åˆ†æ é¿å… N+1 SQL æŸ¥è¯¢ ActiveRecord ä¼˜åŒ–æŠ€å·§ æ•°æ®åº“ SQL ä¼˜åŒ– è®¡æ•°ç¼“å­˜ (Counter Cache) æ”¹è¿› Render Partial çš„æ•ˆèƒ½ æ•°æ®">
<meta name="keywords" content="æ–°ç”Ÿå¤§å­¦å…¨æ ˆè¥,Ruby on Rails,å…¨æ ˆè¥è¯¾ç¨‹å¤ç›˜">
<meta property="og:type" content="article">
<meta property="og:title" content="è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ2ï¼‰">
<meta property="og:url" content="https://kerzzi.github.io/2017/10/06/2017-10-06-rails-website-performance-02/index.html">
<meta property="og:site_name" content="æŸ¯å­çš„è¡Œæ€ç¬”è®°">
<meta property="og:description" content="è¯¾ç¨‹ç›®æ ‡ Part 1: å‰è¨€ ç½‘ç«™æ•ˆèƒ½åŸºç¡€æ¦‚å¿µ   Part 2: å‰ç«¯æ•ˆèƒ½ å‰ç«¯æ•ˆèƒ½åˆ†æ å‡å°‘ Requests æ•°é‡å’Œå¤§å° HTTP æœ€ä½³åŒ– å…³é”®æ¸²æŸ“è·¯å¾„ CDN   Part 3: åç«¯æ•ˆèƒ½ é¡¹ç›®å‡†å¤‡ åç«¯æ•ˆèƒ½åˆ†æ é¿å… N+1 SQL æŸ¥è¯¢ ActiveRecord ä¼˜åŒ–æŠ€å·§ æ•°æ®åº“ SQL ä¼˜åŒ– è®¡æ•°ç¼“å­˜ (Counter Cache) æ”¹è¿› Render Partial çš„æ•ˆèƒ½ æ•°æ®">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://ww1.sinaimg.cn/large/006tNc79ly1fk8g7a3z61j30vm0bcmxp.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/006tNc79ly1fk8g8d0zvpj30wp0npq3z.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/006tNc79gy1fk8mfc7gp8j30xe0qyq40.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/006tNc79gy1fk8mk8znwbj30r006s74k.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/006tNc79gy1fk8nb8rwcvj30w209rmxt.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/006tNc79gy1fk8nc5yrh0j30w007ggm1.jpg">
<meta property="og:image" content="https://ww1.sinaimg.cn/large/006tNc79gy1fk8ndar0vnj30vw07kdga.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/006tNc79gy1fk8nfvrv3qj30wg110tck.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/006tNc79gy1fk8ngorg09j30vw0cvwfg.jpg">
<meta property="og:updated_time" content="2017-10-06T09:40:12.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ2ï¼‰">
<meta name="twitter:description" content="è¯¾ç¨‹ç›®æ ‡ Part 1: å‰è¨€ ç½‘ç«™æ•ˆèƒ½åŸºç¡€æ¦‚å¿µ   Part 2: å‰ç«¯æ•ˆèƒ½ å‰ç«¯æ•ˆèƒ½åˆ†æ å‡å°‘ Requests æ•°é‡å’Œå¤§å° HTTP æœ€ä½³åŒ– å…³é”®æ¸²æŸ“è·¯å¾„ CDN   Part 3: åç«¯æ•ˆèƒ½ é¡¹ç›®å‡†å¤‡ åç«¯æ•ˆèƒ½åˆ†æ é¿å… N+1 SQL æŸ¥è¯¢ ActiveRecord ä¼˜åŒ–æŠ€å·§ æ•°æ®åº“ SQL ä¼˜åŒ– è®¡æ•°ç¼“å­˜ (Counter Cache) æ”¹è¿› Render Partial çš„æ•ˆèƒ½ æ•°æ®">
<meta name="twitter:image" content="https://ww1.sinaimg.cn/large/006tNc79ly1fk8g7a3z61j30vm0bcmxp.jpg">

    
    <link rel="alternative" href="/atom.xml" title="æŸ¯å­çš„è¡Œæ€ç¬”è®°" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.png">
    
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="æŸ¯å­çš„è¡Œæ€ç¬”è®°">æŸ¯å­çš„è¡Œæ€ç¬”è®°</a></h1>
				<h2 class="blog-motto">å«æˆ‘æŸ¯å­å°±å¥½</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="èœå•">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">é¦–é¡µ</a></li>
					
						<li><a href="/archives">å½’æ¡£</a></li>
					
						<li><a href="/tags">æ ‡ç­¾</a></li>
					
						<li><a href="/about">å…³äº</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="æœç´¢" />
						<input type="hidden" name="q" value="site:kerzzi.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/10/06/2017-10-06-rails-website-performance-02/" title="è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ2ï¼‰" itemprop="url">è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ2ï¼‰</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Kerzzi" target="_blank" itemprop="author">Kerzzi</a>
		
  <p class="article-time">
    <time datetime="2017-10-05T16:00:00.000Z" itemprop="datePublished"> å‘è¡¨äº 2017-10-06</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">æ–‡ç« ç›®å½•</strong>
		
			<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#è¯¾ç¨‹ç›®æ ‡"><span class="toc-number">1.</span> <span class="toc-text">è¯¾ç¨‹ç›®æ ‡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#è¯¾ç¨‹å¤ç›˜"><span class="toc-number">2.</span> <span class="toc-text">è¯¾ç¨‹å¤ç›˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-CDN"><span class="toc-number">2.1.</span> <span class="toc-text">1. CDN</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å¦‚ä½•åœ¨-Rails-ä¸Šå®ç°"><span class="toc-number">2.1.1.</span> <span class="toc-text">å¦‚ä½•åœ¨ Rails ä¸Šå®ç°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#åœ¨å“ªå¯ä»¥æ‰¾åˆ°-CDN-æœåŠ¡"><span class="toc-number">2.1.2.</span> <span class="toc-text">åœ¨å“ªå¯ä»¥æ‰¾åˆ° CDN æœåŠ¡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-å…³äº-bundle-exec"><span class="toc-number">2.2.</span> <span class="toc-text">2. å…³äº bundle exec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-åç«¯æ•ˆèƒ½åˆ†æ"><span class="toc-number">2.3.</span> <span class="toc-text">3.åç«¯æ•ˆèƒ½åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å®‰è£…ç¬¬ä¸‰æ–¹æ•ˆèƒ½åˆ†ææœåŠ¡"><span class="toc-number">2.3.1.</span> <span class="toc-text">å®‰è£…ç¬¬ä¸‰æ–¹æ•ˆèƒ½åˆ†ææœåŠ¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#åç«¯æ•ˆèƒ½æé€Ÿçš„æ–¹å‘"><span class="toc-number">2.3.2.</span> <span class="toc-text">åç«¯æ•ˆèƒ½æé€Ÿçš„æ–¹å‘</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-é¿å…-N-1-SQL-æŸ¥è¯¢"><span class="toc-number">2.4.</span> <span class="toc-text">4.é¿å… N+1 SQL æŸ¥è¯¢</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#æ”¹è¿›-posts-show-çš„-N-1"><span class="toc-number">2.4.1.</span> <span class="toc-text">æ”¹è¿› posts#show çš„ N+1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#includes-å¤šä¸ªå…³è”"><span class="toc-number">2.4.2.</span> <span class="toc-text">includes å¤šä¸ªå…³è”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#includes-æœ‰æ¡ä»¶æ€ä¹ˆåŠ"><span class="toc-number">2.4.3.</span> <span class="toc-text">includes æœ‰æ¡ä»¶æ€ä¹ˆåŠ?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ç”¨å·¥å…·è‡ªåŠ¨ä¾¦æµ‹-N-1-Queries"><span class="toc-number">2.4.4.</span> <span class="toc-text">ç”¨å·¥å…·è‡ªåŠ¨ä¾¦æµ‹ N+1 Queries</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-ActiveRecord-ä¼˜åŒ–æŠ€å·§"><span class="toc-number">2.5.</span> <span class="toc-text">5.ActiveRecord ä¼˜åŒ–æŠ€å·§</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#é¿å…-all-æŸ¥è¯¢"><span class="toc-number">2.5.1.</span> <span class="toc-text">é¿å… .all æŸ¥è¯¢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#find-each-æŠ€å·§"><span class="toc-number">2.5.2.</span> <span class="toc-text">find_each æŠ€å·§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#é¢„åŠ è½½-Preload-æ¦‚å¿µ"><span class="toc-number">2.5.3.</span> <span class="toc-text">é¢„åŠ è½½(Preload)æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#count-å’Œ-size-æ–¹æ³•"><span class="toc-number">2.5.4.</span> <span class="toc-text">count å’Œ size æ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#é¿å…é‡å¤-SQL-æŸ¥è¯¢"><span class="toc-number">2.5.5.</span> <span class="toc-text">é¿å…é‡å¤ SQL æŸ¥è¯¢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pluck-æŠ€å·§"><span class="toc-number">2.5.6.</span> <span class="toc-text">pluck æŠ€å·§</span></a></li></ol></li></ol></li></ol>
		
		</div>
		
		<h2 id="è¯¾ç¨‹ç›®æ ‡"><a href="#è¯¾ç¨‹ç›®æ ‡" class="headerlink" title="è¯¾ç¨‹ç›®æ ‡"></a>è¯¾ç¨‹ç›®æ ‡</h2><ul>
<li>Part 1: å‰è¨€<ul>
<li>ç½‘ç«™æ•ˆèƒ½åŸºç¡€æ¦‚å¿µ</li>
</ul>
</li>
<li>Part 2: å‰ç«¯æ•ˆèƒ½<ul>
<li>å‰ç«¯æ•ˆèƒ½åˆ†æ</li>
<li>å‡å°‘ Requests æ•°é‡å’Œå¤§å°</li>
<li>HTTP æœ€ä½³åŒ–</li>
<li>å…³é”®æ¸²æŸ“è·¯å¾„</li>
<li>CDN</li>
</ul>
</li>
<li>Part 3: åç«¯æ•ˆèƒ½<ul>
<li>é¡¹ç›®å‡†å¤‡</li>
<li>åç«¯æ•ˆèƒ½åˆ†æ</li>
<li>é¿å… N+1 SQL æŸ¥è¯¢</li>
<li>ActiveRecord ä¼˜åŒ–æŠ€å·§</li>
<li>æ•°æ®åº“ SQL ä¼˜åŒ–</li>
<li>è®¡æ•°ç¼“å­˜ (Counter Cache)</li>
<li>æ”¹è¿› Render Partial çš„æ•ˆèƒ½</li>
<li>æ•°æ®åº“ç´¢å¼•</li>
<li>åç«¯ç¼“å­˜å’Œå»¶å±•æ€§(Scalability)</li>
</ul>
</li>
</ul>
<h2 id="è¯¾ç¨‹å¤ç›˜"><a href="#è¯¾ç¨‹å¤ç›˜" class="headerlink" title="è¯¾ç¨‹å¤ç›˜"></a>è¯¾ç¨‹å¤ç›˜</h2><h3 id="1-CDN"><a href="#1-CDN" class="headerlink" title="1. CDN"></a>1. CDN</h3><p>æœåŠ¡å™¨å¦‚æœç¦»ç”¨æˆ·æ¯”è¾ƒè¿‘ï¼Œç½‘ç»œä¼ è¾“çš„æ—¶é—´å°±ä¼šæ¯”è¾ƒå¿«ã€‚ä¸è¿‡å¦‚æœç”¨æˆ·æ•£å¸ƒæ˜¯ä¸–ç•Œå„åœ°çš„è¯ï¼Œé‚£ä¹ˆæœåŠ¡å™¨æ”¾å“ªé‡Œéƒ½ä¼šæœ‰äººè·ç¦»æ¯”è¾ƒè¿œã€‚è¿™ç§æƒ…å†µæ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>è¿™æ—¶å€™æˆ‘ä»¬å°±ä¼šä½¿ç”¨ <a href="https://baike.baidu.com/item/CDN" target="_blank" rel="external">CDN (Content delivery network) </a>è¿™ç§æœåŠ¡æ¥åŠ é€Ÿé™æ€æ¡£æ¡ˆçš„ä¸‹è½½ã€‚</p>
<p>CDN å°±æ˜¯ä¸“é—¨ç”¨æ¥æä¾›<strong>é™æ€æ¡£æ¡ˆçš„æœåŠ¡å™¨</strong>ï¼Œç”¨æˆ·ä»è·ç¦»æœ€è¿‘çš„ CDN æœåŠ¡å™¨ä¸‹è½½é™æ€æ¡£æ¡ˆï¼Œå¦‚æœ CDN ä¸Šé¢æ²¡æœ‰éœ€è¦çš„æ¡£æ¡ˆï¼Œé‚£ä¹ˆ CDN ä¼šä»æˆ‘ä»¬çš„æœåŠ¡å™¨ä¸Šä¸‹è½½ä¸€ä»½å›å»ç¼“å­˜èµ·æ¥ã€‚</p>
<blockquote>
<p>åªæœ‰<strong>é™æ€æ¡£æ¡ˆ</strong>ä¾‹å¦‚ CSS/JavaScriptå’Œå›¾ç‰‡ç­‰ç­‰ä¼šæ”¾åœ¨ CDN ä¸Šï¼Œå¦‚æœæ˜¯åŠ¨æ€å†…å®¹ç”¨æˆ·ä¸€å®šè¦è®¿é—®æˆ‘ä»¬è‡ªå·±çš„æœåŠ¡å™¨</p>
</blockquote>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å°† HTML ç½‘é¡µä¸Šé™æ€æ¡£æ¡ˆç½‘å€åˆ†å¼€ï¼Œæ”¹æˆ CDN çš„ç½‘å€ï¼š</p>
<ul>
<li>ä¾‹å¦‚æœåŠ¡å™¨ç½‘ç«™æ˜¯ www.jd.comï¼Œä½ ä¼šä»è¿™ä¸ªç½‘å€å…ˆä¸‹è½½ HTML</li>
<li>ä½†æ˜¯ HTML ä¸Šçš„å›¾ç‰‡ç½‘å€åˆ™æ˜¯ä¸åŒçš„ï¼Œä¾‹å¦‚æ˜¯ cdn.jd.com å¥½äº†ï¼Œè¿™ä¸ªæ˜¯ CDN çš„ç½‘å€<ul>
<li>CDN æŠ€æœ¯åšçš„æ˜¯é’ˆå¯¹ä¸åŒåœ°åŒºçš„ç”¨æˆ·ï¼Œè‡ªåŠ¨æä¾›ä»–ä»¬æœ€è¿‘çš„ç‚¹ä¸‹è½½æ¡£æ¡ˆ</li>
</ul>
</li>
<li>ä¸åŒåœ°åŒºçš„ç”¨æˆ·ï¼Œé’ˆå¯¹ cdn.jd.com ä¼šè§£æå‡ºä¸åŒçš„ IP åœ°å€ï¼Œé€‰æ‹©ç”¨æœ€è¿‘çš„æœåŠ¡å™¨</li>
<li>å¦‚æœ CDN ä¸Šæœ‰æ¡£æ¡ˆç¼“å­˜ï¼Œå°±ç›´æ¥ä» CDN ä¸Šåç»™ç”¨æˆ·</li>
<li>å¦‚æœ CDN ä¸Šæ²¡æœ‰æ¡£æ¡ˆç¼“å­˜ï¼Œå°±ä»åŸç«™æ‹‰ä¸€ä»½ï¼Œå¿«å–åœ¨ CDN ä¸Š</li>
</ul>
<h4 id="å¦‚ä½•åœ¨-Rails-ä¸Šå®ç°"><a href="#å¦‚ä½•åœ¨-Rails-ä¸Šå®ç°" class="headerlink" title="å¦‚ä½•åœ¨ Rails ä¸Šå®ç°"></a>å¦‚ä½•åœ¨ Rails ä¸Šå®ç°</h4><p>ä¸éœ€è¦å»æ”¹ç½‘ç«™ä¸Šçš„ image_tag ä¸€ä¸ªä¸€ä¸ªå¤„ç†ã€‚</p>
<p>åªè¦åœ¨ Rails ä¸Šæ”¹å…¨ç«™çš„å›¾ç‰‡æ¥æºï¼Œåªè¦ä¿®æ”¹ <code>config/enviorments/production.rb</code> é‡Œçš„è¿™ä¸€è¡Œå°±å¯ä»¥äº†ã€‚</p>
<figure class="highlight ruby"><figcaption><span>config/enviorments/production.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">config.action_controller.asset_host = <span class="string">"https://cdn.jd.com"</span></div></pre></td></tr></table></figure>
<p>è¿™æ ·å…¨ç«™çš„ image/css/js ç½‘å€ï¼Œå°±ä¼šå…¨éƒ¨å˜æˆ</p>
<ul>
<li>cdn.jd.com/images/demo.jpg</li>
<li>cdn.jd.com/assets/admin.css</li>
<li>cdn.jd.com/assets/admin.js</li>
</ul>
<h4 id="åœ¨å“ªå¯ä»¥æ‰¾åˆ°-CDN-æœåŠ¡"><a href="#åœ¨å“ªå¯ä»¥æ‰¾åˆ°-CDN-æœåŠ¡" class="headerlink" title="åœ¨å“ªå¯ä»¥æ‰¾åˆ° CDN æœåŠ¡"></a>åœ¨å“ªå¯ä»¥æ‰¾åˆ° CDN æœåŠ¡</h4><p>ä¸­å›½å¢ƒå†… CDN æœåŠ¡(ç½‘ç«™éœ€è¦å¤‡æ¡ˆæ‰èƒ½ç”³è¯·ä½¿ç”¨)</p>
<ul>
<li><a href="https://su.baidu.com/" target="_blank" rel="external">ç™¾åº¦äº‘åŠ é€Ÿ</a></li>
<li><a href="https://www.alibabacloud.com/zh/product/cdn" target="_blank" rel="external">é˜¿é‡Œäº‘</a></li>
<li><a href="https://www.qiniu.com/products/fusion" target="_blank" rel="external">ä¸ƒç‰›äº‘</a></li>
<li><a href="https://www.upyun.com/" target="_blank" rel="external">åˆæ‹äº‘</a></li>
</ul>
<p>å›½å¤– CDN (éšæ—¶ç”³è¯·éšæ—¶ä½¿ç”¨ï¼Œä½†æ˜¯ä¸­å›½å¢ƒå†…æ²¡æœ‰ CDN èŠ‚ç‚¹)</p>
<ul>
<li><a href="https://aws.amazon.com/cloudfront/" target="_blank" rel="external">Amazon Cloudfront</a></li>
<li><a href="https://www.cloudflare.com/" target="_blank" rel="external">Cloudflare</a></li>
</ul>
<h3 id="2-å…³äº-bundle-exec"><a href="#2-å…³äº-bundle-exec" class="headerlink" title="2. å…³äº bundle exec"></a>2. å…³äº bundle exec</h3><p>å‘½ä»¤bundle exec åªæ˜¯è´Ÿè´£åŠ è½½ <code>Gemfile.lock</code> ä¸­çš„ gem.</p>
<p>å¦‚æœä½ ç”¨<code>gem install rake</code>å®‰è£…äº†10.1.0ç‰ˆæœ¬çš„rakeï¼ˆå‡è®¾æ˜¯æœ€æ–°çš„ï¼‰ï¼Œå½“ä½ ç›´æ¥ä½¿ç”¨è°ƒç”¨rakeæ—¶ï¼Œä½¿ç”¨çš„ä¼šæ˜¯è¿™ä¸ªæœ€æ–°ç‰ˆæœ¬çš„rakeã€‚</p>
<p>å¦‚æœé¡¹ç›®çš„Gemfileä¸­æŒ‡å®šçš„ç‰ˆæœ¬æ˜¯0.9.6ï¼ˆæˆ–è€…æ˜¯Gemfile.lockä¸­æ˜¯0.9.6ï¼‰çš„è¯ï¼Œä½ å¦‚æœä¸åŠ <code>bundle exec</code>ï¼Œå°†ä¼šç”¨rake 10.1.0çš„ç‰ˆæœ¬å»æ‰§è¡Œæœ¬æ¥åº”è¯¥ç”±0.9.6ç‰ˆæœ¬çš„rakeå†™å‡ºçš„Rake taskã€‚</p>
<p>ä¼šä¸ä¼šå‡ºé—®é¢˜ï¼Ÿå¯èƒ½ä¼šï¼Œå¯èƒ½ä¸ä¼šã€‚å› ä¸ºå¾ˆæœ‰å¯èƒ½åŸä½œè€…ä½¿ç”¨0.9.6ç‰ˆæœ¬çš„rakeå†™çš„Rake taskä¸­æ²¡æœ‰ä»€ä¹ˆè¢«åºŸå¼ƒçš„éƒ¨åˆ†ï¼Œ10.1.10ä¹Ÿèƒ½æ­£ç¡®æ‰§è¡Œã€‚ä½†æ˜¯ä¸å…¼å®¹çš„æƒ…å†µä¹Ÿä¼šå‘ç”Ÿã€‚</p>
<p><code>bundle exec</code>å°±æ˜¯ä¸ºäº†è§£å†³è¿™æ ·çš„é—®é¢˜è€Œå­˜åœ¨çš„ï¼šåœ¨ç›®å‰çš„Bundleç¯å¢ƒé‡Œæ‰§è¡ŒæŸä¸ªæ“ä½œï¼Œè¿™æ ·å¯¹äºä¸åŒçš„äººæ¥è¯´ï¼Œä¸è®ºç³»ç»Ÿé‡Œæ˜¯ä»€ä¹ˆç‰ˆæœ¬çš„Gemï¼Œ<strong>æ€»æ˜¯ä¼šä½¿ç”¨è¯¥é¡¹ç›®Gemfileä¸­æŒ‡å®šçš„ç‰ˆæœ¬æ¥æ‰§è¡ŒæŸä¸ªæ“ä½œ</strong>ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bundle </span>exec rake db:migrate</div><div class="line"><span class="keyword">bundle </span>exec rake fake</div></pre></td></tr></table></figure>
<h3 id="3-åç«¯æ•ˆèƒ½åˆ†æ"><a href="#3-åç«¯æ•ˆèƒ½åˆ†æ" class="headerlink" title="3.åç«¯æ•ˆèƒ½åˆ†æ"></a>3.åç«¯æ•ˆèƒ½åˆ†æ</h3><p>åç«¯æ•ˆèƒ½è¦å…³æ³¨çš„æ˜¯ä¸ªåˆ« HTTP Request çš„ååº”æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯ Response Timeã€‚</p>
<ul>
<li><p>è¿™ä¸ªæ—¶é—´åœ¨ Rails log ä¸­å¯ä»¥çœ‹åˆ°ã€‚<br><img src="https://ww1.sinaimg.cn/large/006tNc79ly1fk8g7a3z61j30vm0bcmxp.jpg" alt=""></p>
</li>
<li><p>æˆ–æ˜¯å¯ä»¥å®‰è£… <a href="https://github.com/MiniProfiler/rack-mini-profiler" target="_blank" rel="external">rack-mini-profiler</a> è¿™ä¸ª gemï¼Œå°±å¯ä»¥åœ¨ç”»é¢ä¸Šç›´æ¥çœ‹åˆ°è¿™ä¸ªæ•°æ®ï¼š</p>
</li>
</ul>
<p>ç¼–è¾‘ Gemile</p>
<figure class="highlight ruby"><figcaption><span>Gemfile</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">+  gem <span class="string">'rack-mini-profiler'</span></div></pre></td></tr></table></figure>
<p>æ‰§è¡Œ <code>bundle</code>ï¼Œé‡å¼€ Railsã€‚</p>
<p><img src="https://ww4.sinaimg.cn/large/006tNc79ly1fk8g8d0zvpj30wp0npq3z.jpg" alt=""><br>è¿™æ ·ç½‘é¡µå·¦ä¸Šè§’å°±ä¼šå‡ºç° Response Time çš„æ•°æ®ï¼Œç‚¹å¼€æ¥åè¿˜å¯ä»¥è¿›åˆ°è¿›ä¸€æ­¥çš„åˆ†æã€‚</p>
<h4 id="å®‰è£…ç¬¬ä¸‰æ–¹æ•ˆèƒ½åˆ†ææœåŠ¡"><a href="#å®‰è£…ç¬¬ä¸‰æ–¹æ•ˆèƒ½åˆ†ææœåŠ¡" class="headerlink" title="å®‰è£…ç¬¬ä¸‰æ–¹æ•ˆèƒ½åˆ†ææœåŠ¡"></a>å®‰è£…ç¬¬ä¸‰æ–¹æ•ˆèƒ½åˆ†ææœåŠ¡</h4><p>80/20æ³•åˆ™ï¼šä¼šæ‹–æ…¢æ•´ä½“æ•ˆèƒ½çš„ç¨‹å¼ï¼Œåªä½”å…¨éƒ¨ç¨‹å¼çš„ä¸€å°éƒ¨åˆ†è€Œå·²ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæœ€ä½³åŒ–ä¼šé€ æˆé—®é¢˜çš„ç¨‹å¼ã€‚æ¥ä¸‹æ¥çš„é—®é¢˜å°±æ˜¯ï¼Œå¦‚ä½•æ‰¾åˆ°é‚£ä¸€å°éƒ¨åˆ†çš„æ•ˆèƒ½ç“¶é¢ˆã€‚å–„ç”¨åˆ†æå·¥å…·æ‰¾æ•ˆèƒ½ç“¶é¢ˆï¼Œæœ€ä½³åŒ–å‰éœ€è¦æµ‹é‡ï¼Œæœ€ä½³åŒ–åä¹Ÿè¦æµ‹é‡æ¯”è¾ƒã€‚</p>
<p>é€è¿‡ä»¥ä¸‹çš„æ•ˆèƒ½åˆ†ææœåŠ¡ï¼Œå¯ä»¥æ”¶é›†ç½‘ç«™å®é™…è¥è¿çš„æ•°æ®ï¼Œæ‰¾å‡ºå“ªäº›éƒ¨åˆ†æ˜¯æ•ˆèƒ½ä¸å¥½çš„åœ°æ–¹åŠ ä»¥æ”¹å–„ï¼š</p>
<ul>
<li><a href="https://newrelic.com/" target="_blank" rel="external">New Relic</a></li>
<li><a href="https://www.skylight.io/" target="_blank" rel="external">Skylight</a></li>
<li><a href="https://scoutapp.com/" target="_blank" rel="external">Scout</a></li>
</ul>
<p>å¦‚æœä½ æœ‰å®é™…è¥è¿çš„ç½‘ç«™ï¼Œè¯·æŒ‘ä¸€å®¶æ³¨å†Œè¯•ç”¨ï¼Œæ ¹æ®å®ƒçš„è¯´æ˜ä¼šéœ€è¦å®‰è£…å®ƒçš„ gemã€‚</p>
<h4 id="åç«¯æ•ˆèƒ½æé€Ÿçš„æ–¹å‘"><a href="#åç«¯æ•ˆèƒ½æé€Ÿçš„æ–¹å‘" class="headerlink" title="åç«¯æ•ˆèƒ½æé€Ÿçš„æ–¹å‘"></a>åç«¯æ•ˆèƒ½æé€Ÿçš„æ–¹å‘</h4><p>å¯¹åç«¯æ¥è¯´ï¼Œ</p>
<ul>
<li>ä¸€ä¸ªæ–¹å‘æ˜¯æä¾› Rails å’Œ Ruby ä»£ç çš„æ•ˆèƒ½ï¼Œ</li>
<li>ä¸€ä¸ªæ–¹å‘æ˜¯æä¾›æ•°æ®åº“æ–¹é¢çš„æ•ˆèƒ½ã€‚</li>
</ul>
<p>æ ¹æ®ç»éªŒï¼Œ<strong>å¾ˆå¤§çš„æœºç‡ä¼šæ…¢åœ¨æ•°æ®åº“çš„è¯»å–ä¸Š</strong>ï¼Œè¿™æ˜¯å› ä¸º Rails å¼€å‘è€…å¾ˆå®¹æ˜“æ²‰æµ¸åœ¨ ActiveRecord å¸¦æ¥çš„å¼€å‘é«˜æ•ˆç‡ä¸Šï¼Œè€Œå¿½ç•¥äº† ActiveRecord å¾ˆå®¹æ˜“ä¸å°å¿ƒå°±äº§ç”Ÿäº†æ•ˆèƒ½å·®åŠ²çš„ SQL æŸ¥è¯¢ã€‚å­˜å–æ•°æ®åº“æ˜¯ä¸€ç§ç›¸å¯¹äº CPU è¿ç®—å¾ˆæ…¢çš„ I/O ç¡¬ç›˜æ“ä½œï¼šæ¯ä¸€æ¡ SQL æŸ¥è¯¢éƒ½å¾—è€—ä¸Šæ—¶é—´ã€æ‰§è¡Œå›ä¼ çš„ç»“æœä¹Ÿä¼šè¢«è½¬æˆ ActiveRecord å¯¹è±¡ç„¶åæ”¾è¿›å†…å­˜ã€‚</p>
<h3 id="4-é¿å…-N-1-SQL-æŸ¥è¯¢"><a href="#4-é¿å…-N-1-SQL-æŸ¥è¯¢" class="headerlink" title="4.é¿å… N+1 SQL æŸ¥è¯¢"></a>4.é¿å… N+1 SQL æŸ¥è¯¢</h3><p>N+1 queries æ˜¯æ•°æ®åº“æ•ˆèƒ½å¤´å·æ€æ‰‹ã€‚ActiveRecord çš„å…³è”åŠŸèƒ½åŠŸèƒ½å¾ˆæ–¹ä¾¿ï¼Œä½†å¾ˆå®¹æ˜“å‘å‡ºè¿‡å¤šçš„ SQL æŸ¥è¯¢ã€‚åœ¨ç¤ºèŒƒé¡¹ç›®ä¸­ï¼Œæ¯ç¯‡è´´æ–‡(Post) belongs_to ä½œè€…(User)ï¼Œè¯·æ‰“å¼€ç¤ºèŒƒé¡¹ç›®çš„é¦–é¡µ <a href="http://localhost:3000ï¼Œè§‚å¯Ÿä¸€ä¸‹" target="_blank" rel="external">http://localhost:3000ï¼Œè§‚å¯Ÿä¸€ä¸‹</a> Rails Logï¼š</p>
<p><img src="https://ww2.sinaimg.cn/large/006tNc79gy1fk8mfc7gp8j30xe0qyq40.jpg" alt=""></p>
<p>å‘ç°åˆ°å¾ˆå¤šå¾ˆç±»ä¼¼çš„<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">"users"</span>.* <span class="keyword">FROM</span> <span class="string">"users"</span> <span class="keyword">WHERE</span> <span class="string">"users"</span>.<span class="string">"id"</span> = ? <span class="keyword">LIMIT</span> ? [[<span class="string">"id"</span>, XXX], [<span class="string">"LIMIT"</span>, <span class="number">1</span>]]</div></pre></td></tr></table></figure></p>
<p>è€Œä¸”æ ¹æ® <a href="https://github.com/MiniProfiler/rack-mini-profiler" target="_blank" rel="external">rack-mini-profiler </a>çš„æ•°æ®ï¼Œè¿™ä¸€é¡µæ€»å…±å‘å‡ºäº† 26 ä¸ª SQL æŸ¥è¯¢ï¼Œæ€ä¹ˆä¼šè¿™ä¹ˆå¤š?</p>
<p>å…³é”®åœ¨å‡ºåœ¨ <code>app/views/posts/index.html.erb</code></p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">%</span></span></span><span class="ruby"> @posts.each <span class="keyword">do</span> <span class="params">|post|</span> </span><span class="xml"><span class="tag">%&gt;</span></span></div><div class="line"><span class="xml">  <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span></div><div class="line"><span class="xml">    <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span></span></span><span class="ruby"> link_to post.title, post_path(post) </span><span class="xml"><span class="tag">%&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></div><div class="line"><span class="xml">    <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span></span></span><span class="ruby"> post.user.display_name </span><span class="xml"><span class="tag">%&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></div><div class="line"><span class="xml">  <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span></div><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">%</span></span></span><span class="ruby"> <span class="keyword">end</span> </span><span class="xml"><span class="tag">%&gt;</span></span></div></pre></td></tr></table></figure>
<p>è¿™ä¸ªå¾ªç¯ä¸­ï¼Œæ¯ä¸€æ¬¡éƒ½éœ€è¦è¯»å– <code>post.user</code>ï¼Œé€ æˆäº†æ‰€è°“çš„ N+1 é—®é¢˜ï¼Œå½“ä¸€é¡µ Post æœ‰ 25 ç¬”æ—¶ï¼Œæ€»å…±å‘å‡ºäº† 26 ä¸ª SQL æŸ¥è¯¢ï¼Œä¸€ç¬”æ˜¯ <code>SELECT * FROM posts</code>ï¼Œå¦å¤– 25 ç¬”æ˜¯ä¸€ç¬”ä¸€ç¬”å» <code>SELECT * FROM users WHERE users.id = XXX</code>ï¼Œä¸¥é‡æ‹–æ…¢äº†æ•ˆèƒ½ã€‚</p>
<blockquote>
<p>Rails é’ˆå¯¹é‡å¤çš„ SQL æŸ¥è¯¢æœ‰åšç¼“å­˜ï¼Œæ‰€ä»¥æˆªå›¾ä¸­æœ‰çš„æ˜¯ CACHE User Loadã€‚æˆªå›¾ä¸­æœ€åä¸€ä¸ª <code>SQL æŸ¥è¯¢ SELECT COUNT(*) FROM posts</code> æ˜¯è®¡ç®—åˆ†é¡µçš„æ€»é¡µæ•°ç”¨åˆ°çš„ã€‚</p>
</blockquote>
<p>è§£å†³æ–¹æ³•ä¹Ÿä¸éš¾ï¼Œæˆ‘ä»¬éœ€è¦<strong>åœ¨æ posts æ•°æ®çš„æ—¶å€™ï¼Œå°±è¦å…ˆå‘Šè¯‰ ActiveRecord æˆ‘ä»¬ä¹Ÿéœ€è¦ posts çš„ user æ•°æ®ï¼Œ</strong>è¿™æ · ActiveRecord å°±ä¼šé¢„å…ˆæå‡ºæ‰€æœ‰éœ€è¦çš„ users æ•°æ®ã€‚</p>
<p>ç”¨åˆ°çš„è¯­æ³•æ˜¯åŠ ä¸Š includesï¼Œè¯·ä¿®æ”¹ <code>app/controllers/posts_controller.rb</code>ï¼ŒæŠŠéœ€è¦ä¸€èµ·æå‡ºæ¥çš„å…³è” model åŠ ä¸Šå»å³å¯ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/controllers/posts_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">index</span></span></div><div class="line">-    @posts = Post.page(params[<span class="symbol">:page</span>])</div><div class="line">+    @posts = Post.includes(<span class="symbol">:user</span>).page(params[<span class="symbol">:page</span>])</div><div class="line">   <span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>åœ¨è§‚å¯Ÿä¸€æ¬¡ Logï¼ŒSQL æŸ¥è¯¢å°±åªå‰©ä¸‹ä¸¤æ¡äº†ã€‚ä¸€æ¡æ Postsï¼Œä¸€æ¡æ Usersã€‚é€Ÿåº¦ä» 1173ms æå‡åˆ° 117msï¼Œå¿«äº†åå€!<br><img src="https://ww3.sinaimg.cn/large/006tNc79gy1fk8mk8znwbj30r006s74k.jpg" alt=""></p>
<h4 id="æ”¹è¿›-posts-show-çš„-N-1"><a href="#æ”¹è¿›-posts-show-çš„-N-1" class="headerlink" title="æ”¹è¿› posts#show çš„ N+1"></a>æ”¹è¿› posts#show çš„ N+1</h4><p>æ¥ä¸‹æ¥ç‚¹è¿›ä»»ä¸€ç¯‡æ–‡ç« ï¼Œæ–‡ç« æœ‰è®¸å¤šç•™è¨€ï¼Œç•™è¨€çš„ä½œè€…ä¹Ÿæœ‰ä¸€æ ·çš„ N+1 é—®é¢˜ï¼Œè®©æˆ‘ä»¬å¤„ç†ä¸€ä¸‹ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/controllers/posts_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></div><div class="line">    @post = Post.find(params[<span class="symbol">:id</span>])</div><div class="line">-   @comments = @post.comments</div><div class="line">+   @comments = @post.comments.includes(<span class="symbol">:user</span>)</div><div class="line">  <span class="keyword">end</span></div></pre></td></tr></table></figure>
<h4 id="includes-å¤šä¸ªå…³è”"><a href="#includes-å¤šä¸ªå…³è”" class="headerlink" title="includes å¤šä¸ªå…³è”"></a>includes å¤šä¸ªå…³è”</h4><p>includes ä¹Ÿå¯ä»¥ä¸€æ¬¡æå¤šä¸ªå…³è”çš„æ•°æ®ï¼Œé¦–å…ˆè®©æˆ‘ä»¬å¢åŠ ä¸€ä¸ªæƒ…å¢ƒæ˜¯ posts#index é¡µé¢æ˜¾ç¤ºæ¯ç¯‡è´´æ–‡çš„æµè§ˆç”¨æˆ·ï¼Œä»¥åŠæŒ‰è®šçš„ç”¨æˆ·ï¼š</p>
<p>ç¼–è¾‘ <code>app/views/posts/index.html.erb</code></p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/index.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">  &lt;table class="table"&gt;</div><div class="line">    &lt;tr&gt;</div><div class="line">      &lt;th&gt;æ ‡é¢˜&lt;<span class="regexp">/th&gt;</span></div><div class="line"><span class="regexp">      &lt;th&gt;ä½œè€…&lt;/th</span>&gt;</div><div class="line">+     &lt;th&gt;ç•™è¨€ç”¨æˆ·&lt;<span class="regexp">/th&gt;</span></div><div class="line"><span class="regexp">+     &lt;th&gt;æŒ‰è®šç”¨æˆ·&lt;/th</span>&gt;</div><div class="line">    &lt;<span class="regexp">/tr&gt;</span></div><div class="line"><span class="regexp">    &lt;% @posts.each do |post| %&gt;</span></div><div class="line"><span class="regexp">      &lt;tr&gt;</span></div><div class="line"><span class="regexp">        &lt;td&gt;&lt;%= link_to post.title, post_path(post) %&gt;&lt;/td</span>&gt;</div><div class="line">        &lt;td&gt;&lt;%= post.user.display_name %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">+       &lt;td&gt;&lt;%= post.comments.map&#123; |c| c.user.display_name &#125;.join(",") %&gt;&lt;/td</span>&gt;</div><div class="line">+       &lt;td&gt;&lt;%= post.liked_users.map&#123; <span class="params">|u|</span> u.display_name &#125;.join(<span class="string">","</span>) %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">      &lt;/tr</span>&gt;</div><div class="line">    &lt;% <span class="keyword">end</span> %&gt;</div><div class="line">  &lt;<span class="regexp">/table&gt;</span></div></pre></td></tr></table></figure>
<p>å†æ¬¡æµè§ˆ <a href="http://localhost:3000" target="_blank" rel="external">http://localhost:3000</a> çœ‹çœ‹ logï¼Œæœç„¶ N+1 åˆå†’å‡ºæ¥äº†ï¼Œå“æ­»äººçš„å¤šã€‚</p>
<p>è®©æˆ‘ä»¬åŠ ä¸Š includesï¼Œä¿®æ”¹ <code>app/controllers/posts_controller.rb</code>ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/controllers/posts_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">index</span></span></div><div class="line">-    @posts = Post.includes(<span class="symbol">:user</span>).page(params[<span class="symbol">:page</span>])</div><div class="line">+    @posts = Post.includes(<span class="symbol">:user</span>, <span class="symbol">:liked_users</span>, &#123; <span class="symbol">:comments</span> =&gt; <span class="symbol">:user</span> &#125; ).page(params[<span class="symbol">:page</span>])</div><div class="line">   <span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>å…¶ä¸­ <code>{ :comments =&gt; :user }</code> è¿™ä¸ª Hash è¡¨ç¤ºé™¤äº†æ comments ä¹‹å¤–ï¼Œè¿˜åŒ…æ‹¬å®ƒçš„ä¸‹ä¸€å±‚ user å…³è”ã€‚</p>
<h4 id="includes-æœ‰æ¡ä»¶æ€ä¹ˆåŠ"><a href="#includes-æœ‰æ¡ä»¶æ€ä¹ˆåŠ" class="headerlink" title="includes æœ‰æ¡ä»¶æ€ä¹ˆåŠ?"></a>includes æœ‰æ¡ä»¶æ€ä¹ˆåŠ?</h4><p>è¿™ä¸ªèŒƒä¾‹é¡¹ç›®çš„ Comment model æœ‰ä¸€ä¸ªå­—æ®µæ˜¯ status çŠ¶æ€ï¼Œè¡¨ç¤ºè¿™ä¸ªç•™è¨€å¯ä»¥æ˜¯å…¬å¼€(public)æˆ–ç§å¯†ç•™è¨€(private)ï¼Œå› æ­¤åœ¨ posts index é¡µé¢ä¸Šæˆ‘ä»¬å¸Œæœ›ä¸è¦æ˜¾ç¤ºçŠ¶æ€æ˜¯ç§å¯†çš„ç•™è¨€ä½œè€…ï¼š</p>
<p>ç¼–è¾‘ <code>app/models/comment.rb</code> åŠ ä¸Šä¸€ä¸ª scope:</p>
<figure class="highlight ruby"><figcaption><span>app/models/comment.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Comment</span> &lt; ApplicationRecord</span></div><div class="line"></div><div class="line">    belongs_to <span class="symbol">:user</span></div><div class="line">    belongs_to <span class="symbol">:post</span></div><div class="line"></div><div class="line">+   scope <span class="symbol">:visible</span>, -&gt; &#123; where( <span class="symbol">:status</span> =&gt; <span class="string">"public"</span>) &#125;</div><div class="line"></div><div class="line">  <span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ä½ å¯èƒ½ä¼šç›´æ¥ä¿®æ”¹ <code>app/views/posts/index.html.erb</code> å¥—ç”¨è¿™ä¸ª scopeï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/index.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-  &lt;td&gt;&lt;%= post.comments.map&#123; <span class="params">|c|</span> c.user.display_name &#125;.join(<span class="string">","</span>) %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">+  &lt;td&gt;&lt;%= post.comments.visible.map&#123; |c| c.user.display_name &#125;.join(",") %&gt;&lt;/td</span>&gt;</div></pre></td></tr></table></figure>
<p>è§‚å¯Ÿä¸€ä¸‹ rails logï¼Œå¾ˆä¸å¹¸çš„ N+1 åˆå‡ºç°äº†ï¼ŒActiveRecord æ²¡è¿™ä¹ˆèªæ˜ï¼Œå®ƒè®¤ä¸ºäº‹å…ˆ includes çš„ <code>post.comments</code> è·Ÿè¿™é‡Œçš„ <code>post.comments.visible</code> æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥å‘å‡ºäº† <code>N+1 Queries</code>ã€‚</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span></span></span><span class="ruby"> post.comments.visible.map&#123; <span class="params">|c|</span> c.user.display_name &#125;.join(<span class="string">","</span>) </span><span class="xml"><span class="tag">%&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></div></pre></td></tr></table></figure>
<p>mapçš„ç”¨æ³•ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦åœ¨ Post model å¢åŠ ä¸€ä¸ªæœ‰æ¡ä»¶çš„å…³è”ï¼Œä¿®æ”¹ <code>app/models/post.rb</code></p>
<figure class="highlight ruby"><figcaption><span>app/models/post.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">   has_many <span class="symbol">:comments</span></div><div class="line">+  has_many <span class="symbol">:visible_comments</span>, -&gt; &#123; visible &#125;, <span class="symbol">:class_name</span> =&gt; <span class="string">"Comment"</span></div></pre></td></tr></table></figure>
<p>ç„¶åä¿®æ”¹ <code>app/controllers/posts_controller.rb</code> æ”¹ç”¨è¿™ä¸ªæ–°çš„æœ‰æ¡ä»¶çš„å…³è”ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/controllers/posts_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">index</span></span></div><div class="line">-    @posts = Post.includes(<span class="symbol">:user</span>, <span class="symbol">:liked_users</span>, &#123; <span class="symbol">:comments</span> =&gt; <span class="symbol">:user</span> &#125; ).page(params[<span class="symbol">:page</span>])</div><div class="line">+    @posts = Post.includes(<span class="symbol">:user</span>, <span class="symbol">:liked_users</span>, &#123; <span class="symbol">:visible_comments</span> =&gt; <span class="symbol">:user</span> &#125; ).page(params[<span class="symbol">:page</span>])</div><div class="line">   <span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>æœ€åä¿®æ”¹ <code>app/views/posts/index.html.erb</code></p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/index.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-  &lt;td&gt;&lt;%= post.comments.map&#123; <span class="params">|c|</span> c.user.display_name &#125;.join(<span class="string">","</span>) %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">+  &lt;td&gt;&lt;%= post.visible_comments.map&#123; |c| c.user.display_name &#125;.join(",") %&gt;&lt;/td</span>&gt;</div></pre></td></tr></table></figure>
<p>è¿™æ ·å°±å¤§åŠŸå‘Šæˆäº†ï¼Œè§‚å¯Ÿ Rails log å¯ä»¥çœ‹åˆ° N+1 Queries ä¸è§äº†ã€‚</p>
<h4 id="ç”¨å·¥å…·è‡ªåŠ¨ä¾¦æµ‹-N-1-Queries"><a href="#ç”¨å·¥å…·è‡ªåŠ¨ä¾¦æµ‹-N-1-Queries" class="headerlink" title="ç”¨å·¥å…·è‡ªåŠ¨ä¾¦æµ‹ N+1 Queries"></a>ç”¨å·¥å…·è‡ªåŠ¨ä¾¦æµ‹ N+1 Queries</h4><p>Bullet è¿™ä¸ª gem <a href="https://github.com/flyerhzm/bullet" target="_blank" rel="external">https://github.com/flyerhzm/bullet</a> å¯ä»¥åœ¨å¼€å‘æ—¶ååŠ©ä¾¦æµ‹ N+1 queries é—®é¢˜</p>
<h3 id="5-ActiveRecord-ä¼˜åŒ–æŠ€å·§"><a href="#5-ActiveRecord-ä¼˜åŒ–æŠ€å·§" class="headerlink" title="5.ActiveRecord ä¼˜åŒ–æŠ€å·§"></a>5.ActiveRecord ä¼˜åŒ–æŠ€å·§</h3><p>é™¤äº† N+1 ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€äº›ä½¿ç”¨ ActiveRecord è¦æ³¨æ„çš„åœ°æ–¹ï¼Œå…¶ä¸­ä¸€ä¸ªæœ€é‡è¦çš„è§‚å¿µå°±æ˜¯å†…å­˜çš„ä½¿ç”¨ï¼šæ•°æ®åº“çš„æ•°æ®æ”¾åœ¨ç¡¬ç›˜ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ ActiveRecord è¯»å–æ•°æ®æ—¶ï¼Œä¼šå°†æ•°æ®ä»ç¡¬ç›˜è¯»å‡ºï¼Œ<strong>å˜æˆ Ruby å¯¹è±¡æ”¾åœ¨å†…å­˜ä¸­</strong>ï¼Œè¿™æ˜¯ä¼šè€—è´¹å†…å­˜èµ„æºçš„ï¼Œæˆ‘ä»¬éœ€è¦ä¼˜åŒ–å†…å­˜çš„ä½¿ç”¨ã€‚</p>
<h4 id="é¿å…-all-æŸ¥è¯¢"><a href="#é¿å…-all-æŸ¥è¯¢" class="headerlink" title="é¿å… .all æŸ¥è¯¢"></a>é¿å… .all æŸ¥è¯¢</h4><p>ç¡¬ç›˜çš„ç©ºé—´æ¯”å†…å­˜å¤§å¾—å¤šï¼Œæ”¾åœ¨æ•°æ®åº“çš„æ•°æ®å¯èƒ½æˆåƒä¸Šä¸‡ç¬”ã€‚å› æ­¤å½“ä½ ç”¨ä¾‹å¦‚ <code>Post.all</code> æŸ¥è¯¢æ—¶ï¼Œä¼šå°†æ‰€æœ‰çš„ Post æ•°æ®è¯»è¿›å†…å­˜ï¼Œå½“æ•°æ®å¾ˆå¤šæ—¶å°±ä¼šéå¸¸æ…¢ã€‚</p>
<p>è§£å†³æ–¹æ³•æˆ‘ä»¬éƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œå°±æ˜¯ä½¿ç”¨åˆ†é¡µçš„æœºåˆ¶ï¼Œä½¿ç”¨ <a href="https://github.com/mislav/will_paginate" target="_blank" rel="external">will_paginate</a> æˆ– <a href="https://github.com/kaminari/kaminari" target="_blank" rel="external">kaminari</a>æ¥åšåˆ†é¡µåŠŸèƒ½ã€‚</p>
<h4 id="find-each-æŠ€å·§"><a href="#find-each-æŠ€å·§" class="headerlink" title="find_each æŠ€å·§"></a>find_each æŠ€å·§</h4><p>å¦‚æœçœŸçš„éœ€è¦æå‡ºå…¨éƒ¨çš„æ•°æ®åšå¤„ç†ï¼Œå°±éœ€è¦åˆ†æ¬¡ææ‰ä¸ä¼šä¸€æ¬¡æŠŠå†…å­˜åƒå…‰ã€‚Rails é’ˆå¯¹è¿™ä¸ªæƒ…å¢ƒæä¾›äº†<a href="http://api.rubyonrails.org/classes/ActiveRecord/Batches.html" target="_blank" rel="external">æ‰¹æ¬¡æ–¹æ³•</a>ã€‚<br>ä¸€ä¸ªå¸¸è§çš„æƒ…å¢ƒæ˜¯ä¿®ç†æ•°æ®ï¼Œå‡è®¾æˆ‘ä»¬æƒ³è¦åœ¨ Post ä¸Šæ–°å¢ä¸€ä¸ªå­—æ®µæ˜¯ dateï¼Œä½†æ˜¯åˆšæ–°å¢çš„å­—æ®µæ²¡æœ‰æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦èµ°è®¿æ‰€æœ‰çš„ Post è´´æ–‡å»è¡¥ä¸Šè¿™ä¸ªæ•°æ®ï¼š</p>
<p>æ‰§è¡Œ <code>rails g migration add_date_to_posts</code></p>
<p>ç¼–è¾‘ <code>db/migrate/2017XXXXXXXXXX_add_date_to_posts.rb</code></p>
<figure class="highlight ruby"><figcaption><span>db/migrate/2017XXXXXXXXXX_add_date_to_posts.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">   <span class="class"><span class="keyword">class</span> <span class="title">AddDateToPosts</span> &lt; ActiveRecord::Migration[5.1]</span></div><div class="line">     <span class="function"><span class="keyword">def</span> <span class="title">change</span></span></div><div class="line">+      add_column <span class="symbol">:posts</span>, <span class="symbol">:date</span>, <span class="symbol">:date</span></div><div class="line">+</div><div class="line">+      Post.find_each <span class="keyword">do</span> <span class="params">|post|</span></div><div class="line">+        post.date = post.created_at.to_date</div><div class="line">+        post.save( <span class="symbol">:validate</span> =&gt; <span class="literal">false</span> )</div><div class="line">+      <span class="keyword">end</span></div><div class="line">     <span class="keyword">end</span></div><div class="line">   <span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>æ‰§è¡Œ <code>rake db:migrate</code> å°±ä¼šæ–°å¢ date å­—æ®µï¼Œç„¶åç”¨ <code>Post.find_each</code> èµ°è®¿æ‰€æœ‰è´´æ–‡è¡¥ä¸Š date æ•°æ®ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæ¯ä¸€åƒç¬”æ¯ä¸€åƒç¬”å»æå‡º Posts æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡å…¨éƒ¨æå‡ºæ¥ã€‚</p>
<h4 id="é¢„åŠ è½½-Preload-æ¦‚å¿µ"><a href="#é¢„åŠ è½½-Preload-æ¦‚å¿µ" class="headerlink" title="é¢„åŠ è½½(Preload)æ¦‚å¿µ"></a>é¢„åŠ è½½(Preload)æ¦‚å¿µ</h4><p>ç•™è¨€æœ‰åˆ†å…¬å¼€(Public)å’Œç§å¯†(Private)çŠ¶æ€ï¼Œè®©æˆ‘ä»¬ä¿®æ”¹ Post show é¡µé¢æ¥ååº”è¿™ä¸ªéœ€æ±‚ï¼šæ”¹æˆæ˜¾ç¤ºå…¨éƒ¨å…¬å¼€çš„ç•™è¨€ï¼Œä»¥åŠæˆ‘è‡ªå·±çš„ç§å¯†ç•™è¨€ã€‚</p>
<p>ä¿®æ”¹ <code>app/controllers/posts_controller.rb</code></p>
<figure class="highlight ruby"><figcaption><span>app/controllers/posts_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></div><div class="line">    @post = Post.find(params[<span class="symbol">:id</span>])</div><div class="line">-   @comments = @post.comments.includes(<span class="symbol">:user</span>)</div><div class="line">+   @comments = @post.comments.visible.includes(<span class="symbol">:user</span>)</div><div class="line"></div><div class="line">+   <span class="keyword">if</span> current_user</div><div class="line">+     @my_comments = @post.comments.where( <span class="symbol">:status</span> =&gt; <span class="string">"private"</span>, <span class="symbol">:user_id</span> =&gt; current_user.id ).includes(<span class="symbol">:user</span>)</div><div class="line">+   <span class="keyword">end</span></div><div class="line">  <span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>ä¿®æ”¹ <code>app/views/posts/show.html.erb</code> åŠ ä¸Šæˆ‘ä»¬ç§å¯†ç•™è¨€</p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/show.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">  &lt;<span class="regexp">/table&gt;</span></div><div class="line"><span class="regexp"></span></div><div class="line"><span class="regexp">+ &lt;% if current_user %&gt;</span></div><div class="line"><span class="regexp">+   &lt;h2&gt;My Comments&lt;/h</span>2&gt;</div><div class="line">+</div><div class="line">+   &lt;table class="table"&gt;</div><div class="line">+     &lt;% @my_comments.each <span class="keyword">do</span> <span class="params">|comment|</span> %&gt;</div><div class="line">+       &lt;tr&gt;</div><div class="line">+         &lt;td&gt;&lt;%= comment.content %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">+         &lt;td&gt;&lt;%= comment.user.display_name %&gt;&lt;/td</span>&gt;</div><div class="line">+       &lt;<span class="regexp">/tr&gt;</span></div><div class="line"><span class="regexp">+     &lt;% end %&gt;</span></div><div class="line"><span class="regexp">+   &lt;/table</span>&gt;</div><div class="line">+ &lt;% <span class="keyword">end</span> %&gt;</div></pre></td></tr></table></figure>
<p>çœ‹çœ‹ log å¯ä»¥çœ‹åˆ°æ comments æäº†ä¸¤æ¬¡ï¼Œä¸€æ¬¡æ˜¯æå…¬å¼€ç•™è¨€ï¼Œä¸€æ¬¡æ˜¯ææˆ‘çš„ç•™è¨€ã€‚<br><img src="https://ww2.sinaimg.cn/large/006tNc79gy1fk8nb8rwcvj30w209rmxt.jpg" alt=""></p>
<p>ä¸è¿‡ï¼Œå¦‚æœä½ ä»”ç»†æƒ³æƒ³ï¼Œè¿™ä¸¤ä¸ªæŸ¥è¯¢æ ¹æœ¬å°±å¯ä»¥ä¸€æ¬¡å°±æå‡ºæ¥ï¼Œä¿®æ”¹ <code>app/controllers/posts_controller.rb</code></p>
<figure class="highlight ruby"><figcaption><span>app/controllers/posts_controller.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">show</span></span></div><div class="line">     @post = Post.find(params[<span class="symbol">:id</span>])</div><div class="line">-    @comments = @post.comments.visible.includes(<span class="symbol">:user</span>)</div><div class="line"></div><div class="line">     <span class="keyword">if</span> current_user</div><div class="line">-      @my_comments = @post.comments.where( <span class="symbol">:status</span> =&gt; <span class="string">"private"</span>, <span class="symbol">:user_id</span> =&gt; current_user.id ).includes(<span class="symbol">:user</span>)</div><div class="line"></div><div class="line">+      all_comments = @post.comments.where(<span class="string">"status = ? OR (status = ? AND user_id = ?)"</span>, <span class="string">"public"</span>, <span class="string">"private"</span>, current_user.id).includes(<span class="symbol">:user</span>)</div><div class="line">+      @comments = all_comments.select&#123; <span class="params">|x|</span> x.status == <span class="string">"public"</span> &#125;</div><div class="line">+      @my_comments = all_comments.select&#123; <span class="params">|x|</span> x.status == <span class="string">"private"</span> &#125;</div><div class="line"></div><div class="line">+    <span class="keyword">else</span></div><div class="line">+      @comments  = @post.comments.visible.includes(<span class="symbol">:user</span>)</div><div class="line">     <span class="keyword">end</span></div><div class="line">   <span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>all_comments å°±æ˜¯æˆ‘ä»¬é¢„å…ˆæå‡ºæ¥çš„ commentsï¼Œåˆ©ç”¨äº† SQL æ¡ä»¶</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="string">"status = ? OR (status = ? AND user_id = ?)"</span></div></pre></td></tr></table></figure>
<p>æå‡ºæ‰€æœ‰å…¬å¼€æˆ–æˆ‘çš„ç§å¯†ç•™è¨€ã€‚ç„¶å @comment å’Œ @my_comments æ˜¯ç”¨ select è¿™ä¸ªæ•°ç»„æ–¹æ³•ï¼Œä»å†…å­˜ä¸­å†åˆ†åˆ«è¿‡æ»¤å‡ºå…¬å¼€ç•™è¨€å’Œæˆ‘çš„ç§å¯†ç•™è¨€ã€‚</p>
<p>è¿™å°±æ˜¯é¢„å…ˆåŠ è½½(Preload)æ¦‚å¿µ: æˆ‘ä»¬å°½å¯èƒ½åˆå¹¶ SQL æŸ¥è¯¢ä¸€æ¬¡æå‡ºï¼Œç„¶åå†ç”¨æ•°ç»„æ–¹æ³• select è¿‡æ»¤å‡ºéœ€è¦çš„ç»“æœã€‚</p>
<p>å†æ¬¡çœ‹ä¸€ä¸‹ logï¼Œåªæäº†ä¸€æ¬¡ comments äº†ã€‚<br><img src="https://ww2.sinaimg.cn/large/006tNc79gy1fk8nc5yrh0j30w007ggm1.jpg" alt=""></p>
<h4 id="count-å’Œ-size-æ–¹æ³•"><a href="#count-å’Œ-size-æ–¹æ³•" class="headerlink" title="count å’Œ size æ–¹æ³•"></a>count å’Œ size æ–¹æ³•</h4><p><code>count</code> å’Œ <code>size</code> æ–¹æ³•éƒ½å¯ä»¥æŸ¥è¯¢æ•°é‡ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æœ‰ä»€ä¹ˆå·®å¼‚å—ï¼Ÿæˆ‘ä»¬åœ¨ posts show é¡µé¢ä¸Šæ˜¾ç¤ºä¸€ä¸‹ç•™è¨€çš„æ•°é‡ï¼Œè¯·<br>ç¼–è¾‘ <code>app/views/posts/show.html.erb</code>ï¼Œåœ¨æœ€ä¸‹æ–¹åŠ å…¥ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/show.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">Total:</span> &lt;%= @comments.count %&gt;</div><div class="line"><span class="symbol">Total:</span> &lt;%= @comments.count %&gt;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæ•…æ„æ”¾ä¸¤è¡Œæ¥ç¤ºèŒƒæ•ˆæœ<br>ç„¶åçœ‹ä¸€ä¸‹ log:<br><img src="https://ww1.sinaimg.cn/large/006tNc79gy1fk8ndar0vnj30vw07kdga.jpg" alt=""></p>
<p>ä¼šçœ‹åˆ°æœ‰ä¸¤æ¡ COUNT çš„ SQLã€‚è®©æˆ‘ä»¬æ”¹æˆ .size æ–¹æ³•çœ‹çœ‹ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/show.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- <span class="symbol">Total:</span> &lt;%= @comments.count %&gt;</div><div class="line">- <span class="symbol">Total:</span> &lt;%= @comments.count %&gt;</div><div class="line">+ <span class="symbol">Total:</span> &lt;%= @comments.size %&gt;</div><div class="line">+ <span class="symbol">Total:</span> &lt;%= @comments.size %&gt;</div></pre></td></tr></table></figure>
<p>ä¼šå‘ç°ç«Ÿç„¶æ²¡æœ‰ COUNT SQL äº†ã€‚</p>
<ul>
<li>è°ƒç”¨ count æ–¹æ³•æ˜¯å¯¹æ•°æ®åº“é€å‡ºä¸€æ¬¡ COUNT çš„ SQL æŸ¥è¯¢</li>
<li>è€Œsize æ˜¯æ•°ç»„çš„æ–¹æ³•ï¼Œå› ä¸º @comments è¿™ä¸ªå¯¹è±¡å·²ç»åœ¨å†…å­˜äº†ï¼Œè°ƒç”¨ size æ˜¯å»è®¡ç®—è¿™ä¸ª @commentsé‡Œé¢å…ƒç´ çš„æ•°é‡ï¼Œå› æ­¤ä¸éœ€è¦å†å‘å‡º COUNT çš„ SQL æŸ¥è¯¢ã€‚</li>
</ul>
<p>åœ¨è¿™ä¸ªèŒƒä¾‹ä¸­ï¼Œå› ä¸ºç”»é¢ä¸­å·²ç»æ˜¾ç¤ºäº† @commentsï¼Œè¡¨ç¤ºè¿™ä¸ªæ•°æ®å·²ç»ä»æ•°æ®åº“ä¸­æå‡ºï¼Œæ‰€ä»¥é€‚åˆç”¨ <code>.size</code> æ–¹æ³•ï¼Œè€Œä¸éœ€è¦ç”¨ <code>.count</code> é‡å¤å†é—®ä¸€æ¬¡æ•°æ®åº“ã€‚</p>
<p>è®©æˆ‘ä»¬æ¢ä¸€ä¸ªæƒ…å¢ƒï¼Œåœ¨ posts index é¡µé¢ä¸Šæ˜¾ç¤ºç•™è¨€çš„æ•°é‡ï¼Œè¯·ä¿®æ”¹ <code>app/views/posts/index.html.erb</code>ï¼ŒåŠ ä¸Šç•™è¨€æ•°ï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/index.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">  &lt;table class="table"&gt;</div><div class="line">    &lt;tr&gt;</div><div class="line">      &lt;th&gt;æ ‡é¢˜&lt;<span class="regexp">/th&gt;</span></div><div class="line"><span class="regexp">      &lt;th&gt;ä½œè€…&lt;/th</span>&gt;</div><div class="line">+     &lt;th&gt;ç•™è¨€æ•°&lt;<span class="regexp">/th&gt;</span></div><div class="line"><span class="regexp">      &lt;th&gt;ç•™è¨€ç”¨æˆ·&lt;/th</span>&gt;</div><div class="line">      &lt;th&gt;æŒ‰è®šç”¨æˆ·&lt;<span class="regexp">/th&gt;</span></div><div class="line"><span class="regexp">    &lt;/tr</span>&gt;</div><div class="line">    &lt;% @posts.each <span class="keyword">do</span> <span class="params">|post|</span> %&gt;</div><div class="line">      &lt;tr&gt;</div><div class="line">        &lt;td&gt;</div><div class="line">          &lt;% <span class="keyword">if</span> current_user &amp;&amp; current_user.like_post?(post) %&gt;</div><div class="line">            ğŸ‘ğŸ‘ğŸ‘</div><div class="line">          &lt;% <span class="keyword">end</span> %&gt;</div><div class="line">          &lt;%= link_to post.title, post_path(post) %&gt;</div><div class="line">        &lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">        &lt;td&gt;&lt;%= post.user.display_name %&gt;&lt;/td</span>&gt;</div><div class="line">+       &lt;td&gt;&lt;%= post.visible_comments.count %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">        &lt;td&gt;&lt;%= post.visible_comments.map&#123; |c| c.user.display_name &#125;.join(",") %&gt;&lt;/td</span>&gt;</div><div class="line">        &lt;td&gt;&lt;%= post.liked_users.map&#123; <span class="params">|u|</span> u.display_name &#125;.join(<span class="string">","</span>) %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">      &lt;/tr</span>&gt;</div><div class="line">    &lt;% <span class="keyword">end</span> %&gt;</div><div class="line">  &lt;<span class="regexp">/table&gt;</span></div></pre></td></tr></table></figure>
<p>çœ‹ä¸€ä¸‹ logï¼Œå‘ç° N+1 åˆå‡ºæ¥äº†ã€‚</p>
<p>è¿™ä¸ªæƒ…å¢ƒä¸‹ç”¨ count å°±ä¸å¯¹äº†ï¼Œå› ä¸º <code>post.visible_comments</code> æˆ‘ä»¬å…¶å®å·²ç»æå‡ºæ¥äº†ï¼Œåº”è¯¥ç”¨ size æ–¹æ³•å»ç®—å³å¯ï¼Œä¸éœ€è¦å†é—®ä¸€æ¬¡æ•°æ®åº“ï¼š</p>
<figure class="highlight erb"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="xml">-       <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span></span></span><span class="ruby"> post.visible_comments.count </span><span class="xml"><span class="tag">%&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></div><div class="line"><span class="xml">-       <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">%=</span></span></span><span class="ruby"> post.visible_comments.size </span><span class="xml"><span class="tag">%&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span></div></pre></td></tr></table></figure>
<p>å†çœ‹ä¸€æ¬¡ logï¼Œå¤šçš„ SQL queries ç°åœ¨éƒ½æ²¡äº†ã€‚</p>
<h4 id="é¿å…é‡å¤-SQL-æŸ¥è¯¢"><a href="#é¿å…é‡å¤-SQL-æŸ¥è¯¢" class="headerlink" title="é¿å…é‡å¤ SQL æŸ¥è¯¢"></a>é¿å…é‡å¤ SQL æŸ¥è¯¢</h4><p>æƒ…å¢ƒæ˜¯æˆ‘ä»¬æƒ³åœ¨ posts index é¡µé¢ä¸Šæ˜¾ç¤ºæˆ‘æ˜¯å¦æœ‰æŒ‰è¿‡è®šï¼š</p>
<p>ä¿®æ”¹ <code>app/models/user.rb</code>ï¼Œè®©æˆ‘ä»¬æ–°å¢ä¸€ä¸ªæ–¹æ³•åˆ¤æ–­ User æœ‰æ²¡æœ‰é’ˆå¯¹ä¸€ç¯‡ Post æŒ‰è¿‡ Likeï¼š</p>
<figure class="highlight ruby"><figcaption><span>app/models/user.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">like_post?</span><span class="params">(post)</span></span></div><div class="line">  <span class="comment"># æˆ–æ˜¯å†™ self.likes.where( :post_id =&gt; post.id ).first.present? ä¹Ÿå¯ä»¥</span></div><div class="line">  <span class="keyword">self</span>.likes.where( <span class="symbol">:post_id</span> =&gt; post.id ).exists?</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>ä¿®æ”¹ <code>app/views/posts/index.html.erb</code></p>
<figure class="highlight ruby"><figcaption><span>app/views/posts/index.html.erb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">-      &lt;td&gt;&lt;%= link_to post.title, post_path(post) %&gt;&lt;<span class="regexp">/td&gt;</span></div><div class="line"><span class="regexp">+      &lt;td&gt;</span></div><div class="line"><span class="regexp">+        &lt;% if current_user &amp;&amp; current_user.like_post?(post) %&gt;</span></div><div class="line"><span class="regexp">+          ğŸ‘ğŸ‘ğŸ‘</span></div><div class="line"><span class="regexp">+        &lt;% end %&gt;</span></div><div class="line"><span class="regexp">+        &lt;%= link_to post.title, post_path(post) %&gt;</span></div><div class="line"><span class="regexp">+      &lt;/td</span>&gt;</div></pre></td></tr></table></figure>
<p>ä»£ç çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œä¸€ä¸‹å°±å†™å¥½äº†ï¼Œè®©æˆ‘çœ‹çœ‹å¯¹æ•ˆèƒ½æœ‰æ²¡æœ‰å½±å“ï¼š<br><img src="https://ww4.sinaimg.cn/large/006tNc79gy1fk8nfvrv3qj30wg110tck.jpg" alt=""></p>
<p>å“æ­»äººï¼Œæ€ä¹ˆå¤šå‡ºè¿™ä¹ˆå¤šå¤š <code>SELECT &quot;likes&quot;.* FROM &quot;likes&quot; WHERE &quot;likes&quot;.&quot;user_id&quot; = ? AND &quot;likes&quot;.&quot;post_id&quot; = ? ORDER BY &quot;likes&quot;.&quot;id&quot; ASC LIMIT ?</code>ï¼Œæ¯ç¯‡è´´æ–‡éƒ½å»æŸ¥è¯¢ä¸€æ¬¡æœ‰æ²¡æœ‰ Likeã€‚</p>
<p>å¦‚æœä½ å·²ç»æœ‰äº†ä¸Šä¸€èŠ‚é¢„åŠ è½½(Preload)è§‚å¿µï¼Œå°±ä¼šè”æƒ³åˆ°è¿™ä¸ª likes æ•°æ®ï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€ç« å…¶å®å·²ç»æå‡ºæ¥äº†ï¼Œä¹Ÿå°±æ˜¯ liked_usersï¼Œæˆ‘ä»¬åº”è¯¥å»æ£€æŸ¥è´´æ–‡çš„ liked_users é‡Œé¢æœ‰æ²¡æœ‰æˆ‘è‡ªå·±ï¼Œå°±å¯ä»¥åˆ¤æ–­æˆ‘æœ‰æ²¡æœ‰æŒ‰è¿‡è®šäº†ã€‚</p>
<p>ä¿®æ”¹ <code>app/models/user.rb</code></p>
<figure class="highlight ruby"><figcaption><span>app/models/user.rb</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">like_post?</span><span class="params">(post)</span></span></div><div class="line">-    <span class="keyword">self</span>.likes.where( <span class="symbol">:post_id</span> =&gt; post.id ).exists?</div><div class="line">     <span class="comment"># post.liked_users å®é™…ä¸Šåœ¨ controler ä¸­å·²ç»è¢«å–å‡ºæ”¾è¿›å†…å­˜äº†ï¼Œè¿™é‡Œç”¨æ•°ç»„çš„ include? æ–¹æ³•å»æ£€æŸ¥é‡Œé¢æœ‰æ²¡æœ‰æˆ‘è‡ªå·±</span></div><div class="line">+    post.liked_users.<span class="keyword">include</span>?(<span class="keyword">self</span>)</div><div class="line">   <span class="keyword">end</span></div></pre></td></tr></table></figure>
<p>å†æ¬¡çœ‹ä¸€ä¸‹ logï¼Œå‘ç°å¤šçš„ SQL éƒ½ä¸è§äº† ğŸ‘ğŸ‘ğŸ‘<br><img src="https://ww2.sinaimg.cn/large/006tNc79gy1fk8ngorg09j30vw0cvwfg.jpg" alt=""></p>
<p>ä¸è¿‡è¯·æ”¾å¿ƒï¼šä½ æ˜¯å¾ˆéš¾æœ‰å…ˆè§ä¹‹æ˜çŸ¥é“è¦è¿™æ ·å†™çš„ï¼Œå› ä¸ºä¸åŒé¡µé¢ä¼šåŠ è½½çš„æ•°æ®ä¸åŒï¼Œéœ€è¦å› åœ°åˆ¶å®œçš„ä¼˜åŒ–ã€‚</p>
<h4 id="pluck-æŠ€å·§"><a href="#pluck-æŠ€å·§" class="headerlink" title="pluck æŠ€å·§"></a>pluck æŠ€å·§</h4><p>ä½¿ç”¨ ActiveRecord ä»æ•°æ®åº“ä¸­å–å‡ºæ•°æ®æ—¶ï¼Œä¼šå½¢æˆ ActiveRecord å¯¹è±¡æ”¾è¿›å†…å­˜ï¼Œè€Œè¿™ä¸ª ActiveRecord ç±»å…¶å®æœ‰ç‚¹è‚¥å¤§ï¼Œå› ä¸ºå®ƒæœ¬èº«åŒ…å«å¾ˆå¤šæ“ä½œæ–¹æ³•ç­‰ç­‰ã€‚å› æ­¤åœ¨åªéœ€è¦å–å‡ºå•çº¯æ•°æ®ï¼Œè€Œä¸éœ€è¦ ActiveRecord ä»»ä½•åŠŸèƒ½çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨ <code>pluck</code> æ–¹æ³•ï¼Œä¾‹å¦‚æˆ‘ä»¬åªæƒ³è¦å–å‡ºæ‰€æœ‰ç”¨æˆ·çš„ email æ•°æ®ï¼š<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">emails = User.all.map&#123; |<span class="type">u</span>| <span class="type">u</span>.email &#125;</div></pre></td></tr></table></figure></p>
<p>å’Œ<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">emails</span> = User.pluck(:email)</div></pre></td></tr></table></figure></p>
<p>ä¸¤è€…çš„é€Ÿåº¦å·®äº†éå¸¸å¤šï¼šå‰è€…éœ€è¦å°†æ‰€æœ‰ç”¨æˆ·æå‡ºæ¥å˜æˆ ActiveRecord å¯¹è±¡ï¼Œç„¶åå†è½¬æˆ email çš„æ•°ç»„ã€‚åè€…ç›´æ¥å°±æ˜¯ email æ•°ç»„ã€‚</p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Ruby-on-Rails/">Ruby on Rails</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/æ–°ç”Ÿå¤§å­¦å…¨æ ˆè¥/">æ–°ç”Ÿå¤§å­¦å…¨æ ˆè¥</a><a href="/tags/Ruby-on-Rails/">Ruby on Rails</a><a href="/tags/å…¨æ ˆè¥è¯¾ç¨‹å¤ç›˜/">å…¨æ ˆè¥è¯¾ç¨‹å¤ç›˜</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="https://kerzzi.github.io/2017/10/06/2017-10-06-rails-website-performance-02/" data-title="è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ2ï¼‰ | æŸ¯å­çš„è¡Œæ€ç¬”è®°" data-tsina="" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/10/06/2017-10-06-rails-website-performance-03/" title="è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ3ï¼‰">
  <strong>ä¸Šä¸€ç¯‡ï¼š</strong><br/>
  <span>
  è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ3ï¼‰</span>
</a>
</div>


<div class="next">
<a href="/2017/10/04/2017-10-06-rails-website-performance-01/"  title="è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ1ï¼‰">
 <strong>ä¸‹ä¸€ç¯‡ï¼š</strong><br/> 
 <span>è¯¾ç¨‹å¤ç›˜ | Rails ç½‘ç«™æ•ˆèƒ½ï¼ˆ1ï¼‰
</span>
</a>
</div>

</nav>

	


</div>  
      <div class="openaside"><a class="navbutton" href="#" title="æ˜¾ç¤ºä¾§è¾¹æ "></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">æ–‡ç« ç›®å½•</strong>
 
 <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#è¯¾ç¨‹ç›®æ ‡"><span class="toc-number">1.</span> <span class="toc-text">è¯¾ç¨‹ç›®æ ‡</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#è¯¾ç¨‹å¤ç›˜"><span class="toc-number">2.</span> <span class="toc-text">è¯¾ç¨‹å¤ç›˜</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-CDN"><span class="toc-number">2.1.</span> <span class="toc-text">1. CDN</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å¦‚ä½•åœ¨-Rails-ä¸Šå®ç°"><span class="toc-number">2.1.1.</span> <span class="toc-text">å¦‚ä½•åœ¨ Rails ä¸Šå®ç°</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#åœ¨å“ªå¯ä»¥æ‰¾åˆ°-CDN-æœåŠ¡"><span class="toc-number">2.1.2.</span> <span class="toc-text">åœ¨å“ªå¯ä»¥æ‰¾åˆ° CDN æœåŠ¡</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-å…³äº-bundle-exec"><span class="toc-number">2.2.</span> <span class="toc-text">2. å…³äº bundle exec</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-åç«¯æ•ˆèƒ½åˆ†æ"><span class="toc-number">2.3.</span> <span class="toc-text">3.åç«¯æ•ˆèƒ½åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å®‰è£…ç¬¬ä¸‰æ–¹æ•ˆèƒ½åˆ†ææœåŠ¡"><span class="toc-number">2.3.1.</span> <span class="toc-text">å®‰è£…ç¬¬ä¸‰æ–¹æ•ˆèƒ½åˆ†ææœåŠ¡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#åç«¯æ•ˆèƒ½æé€Ÿçš„æ–¹å‘"><span class="toc-number">2.3.2.</span> <span class="toc-text">åç«¯æ•ˆèƒ½æé€Ÿçš„æ–¹å‘</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-é¿å…-N-1-SQL-æŸ¥è¯¢"><span class="toc-number">2.4.</span> <span class="toc-text">4.é¿å… N+1 SQL æŸ¥è¯¢</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#æ”¹è¿›-posts-show-çš„-N-1"><span class="toc-number">2.4.1.</span> <span class="toc-text">æ”¹è¿› posts#show çš„ N+1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#includes-å¤šä¸ªå…³è”"><span class="toc-number">2.4.2.</span> <span class="toc-text">includes å¤šä¸ªå…³è”</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#includes-æœ‰æ¡ä»¶æ€ä¹ˆåŠ"><span class="toc-number">2.4.3.</span> <span class="toc-text">includes æœ‰æ¡ä»¶æ€ä¹ˆåŠ?</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ç”¨å·¥å…·è‡ªåŠ¨ä¾¦æµ‹-N-1-Queries"><span class="toc-number">2.4.4.</span> <span class="toc-text">ç”¨å·¥å…·è‡ªåŠ¨ä¾¦æµ‹ N+1 Queries</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-ActiveRecord-ä¼˜åŒ–æŠ€å·§"><span class="toc-number">2.5.</span> <span class="toc-text">5.ActiveRecord ä¼˜åŒ–æŠ€å·§</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#é¿å…-all-æŸ¥è¯¢"><span class="toc-number">2.5.1.</span> <span class="toc-text">é¿å… .all æŸ¥è¯¢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#find-each-æŠ€å·§"><span class="toc-number">2.5.2.</span> <span class="toc-text">find_each æŠ€å·§</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#é¢„åŠ è½½-Preload-æ¦‚å¿µ"><span class="toc-number">2.5.3.</span> <span class="toc-text">é¢„åŠ è½½(Preload)æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#count-å’Œ-size-æ–¹æ³•"><span class="toc-number">2.5.4.</span> <span class="toc-text">count å’Œ size æ–¹æ³•</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#é¿å…é‡å¤-SQL-æŸ¥è¯¢"><span class="toc-number">2.5.5.</span> <span class="toc-text">é¿å…é‡å¤ SQL æŸ¥è¯¢</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pluck-æŠ€å·§"><span class="toc-number">2.5.6.</span> <span class="toc-text">pluck æŠ€å·§</span></a></li></ol></li></ol></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="éšè—ä¾§è¾¹æ "></a></div>
<aside class="clearfix">

  <div class="sponsor">
  <br />
  <p class="asidetitle">èµåŠ©å•†</p>
  <a href="/sponsor">
  <br />
  <img src="https://ww2.sinaimg.cn/large/006tNc79ly1fk2zsxnnmpj30b405iq2t.jpg" width="235px" />
  </a>

  <!--
  <br /><a href="/sponsor"><font color='#2ca6cb'>è´­ä¹°å¹¿å‘Šä½</font></a>
  -->
</div>

  
<div class="categorieslist">
	<p class="asidetitle">åˆ†ç±»</p>
		<ul>
		
		  
			<li><a href="/categories/Github/" title="Github">Github</a></li>
		  
		
		  
			<li><a href="/categories/Mac/" title="Mac">Mac</a></li>
		  
		
		  
			<li><a href="/categories/Markdown/" title="Markdown">Markdown</a></li>
		  
		
		  
			<li><a href="/categories/Meetup/" title="Meetup">Meetup</a></li>
		  
		
		  
			<li><a href="/categories/ORID/" title="ORID">ORID</a></li>
		  
		
		  
			<li><a href="/categories/Photo/" title="Photo">Photo</a></li>
		  
		
		  
			<li><a href="/categories/Ruby-on-Rails/" title="Ruby on Rails">Ruby on Rails</a></li>
		  
		
		  
			<li><a href="/categories/Ruby-on-rails/" title="Ruby on rails">Ruby on rails</a></li>
		  
		
		  
			<li><a href="/categories/freeCodeCamp/" title="freeCodeCamp">freeCodeCamp</a></li>
		  
		
		  
			<li><a href="/categories/git/" title="git">git</a></li>
		  
		
		  
			<li><a href="/categories/ä¸¤æœ€ä¸€å‘/" title="ä¸¤æœ€ä¸€å‘">ä¸¤æœ€ä¸€å‘</a></li>
		  
		
		  
			<li><a href="/categories/å…ƒå­¦ä¹ /" title="å…ƒå­¦ä¹ ">å…ƒå­¦ä¹ </a></li>
		  
		
		  
			<li><a href="/categories/å…¨æ ˆè¥/" title="å…¨æ ˆè¥">å…¨æ ˆè¥</a></li>
		  
		
		  
			<li><a href="/categories/å…³äºå†™ä½œ/" title="å…³äºå†™ä½œ">å…³äºå†™ä½œ</a></li>
		  
		
		  
			<li><a href="/categories/åŒºå—é“¾/" title="åŒºå—é“¾">åŒºå—é“¾</a></li>
		  
		
		  
			<li><a href="/categories/å–„ç”¨ä½³è½¯/" title="å–„ç”¨ä½³è½¯">å–„ç”¨ä½³è½¯</a></li>
		  
		
		  
			<li><a href="/categories/ç›´æ’­ç¬”è®°/" title="ç›´æ’­ç¬”è®°">ç›´æ’­ç¬”è®°</a></li>
		  
		
		  
			<li><a href="/categories/é€šå¾€è´¢å¯Œè‡ªç”±ä¹‹è·¯/" title="é€šå¾€è´¢å¯Œè‡ªç”±ä¹‹è·¯">é€šå¾€è´¢å¯Œè‡ªç”±ä¹‹è·¯</a></li>
		  
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">å‹æƒ…é“¾æ¥</p>
    <ul>
        
          <li>
            
            	<a href="https://steemit.com/@seeyoo" target="_blank" title="Kerzzi&#39;s Steem">Kerzzi&#39;s Steem</a>
            
          </li>
        
          <li>
            
            	<a href="http://kerzzi.logdown.com/" target="_blank" title="Old Blog">Old Blog</a>
            
          </li>
        
          <li>
            
            	<a href="https://github.com/Kerzzi" target="_blank" title="Kerzzi&#39;s Github">Kerzzi&#39;s Github</a>
            
          </li>
        
          <li>
            
            	<a href="http://mindhacks.cn/" target="_blank" title="åˆ˜æœªé¹">åˆ˜æœªé¹</a>
            
          </li>
        
          <li>
            
            	<a href="https://coolshell.cn/" target="_blank" title="é…·å£³">é…·å£³</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.ruanyifeng.com/" target="_blank" title="é˜®ä¸€å³°">é˜®ä¸€å³°</a>
            
          </li>
        
    </ul>
</div>

  <div class="weixin">
  <br />
  <p class="asidetitle">å¾®ä¿¡å…¬ä¼—å·</p>
  <p>å…³æ³¨æˆ‘çš„å…¬ä¼—å·ã€Œå«æˆ‘æŸ¯å­å°±å¥½ã€ï¼Œä¸ä½ åˆ†äº«å…³äºå®è·µçš„é«˜é¢‘å°å¥—è·¯ï¼š</p>
  <img src="https://ww2.sinaimg.cn/large/006tNc79ly1fk2yv4g9d3j3076076wel.jpg" width="220px" />
 </div>

  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS è®¢é˜…</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> Â© 2017 
		
		<a href="/about" target="_blank" title="Kerzzi">Kerzzi</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="å¾®ä¿¡"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="äººäºº"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="å¾®åš"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>











<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?61e2f14c0f84a3ab81a328239a38b6d8";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="è¿”å›é¡¶éƒ¨"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
